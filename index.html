<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—¥æ—¥å¸³ Nichinichi</title>
    
    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="æ—¥æ—¥å¸³">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/doodle/192/books.png"> 

    <!-- 1. è¼‰å…¥å‡½å¼åº« (Tailwind & React) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* iOS åŸç”Ÿæ„Ÿå„ªåŒ– */
        body { 
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #F2F0EB; 
            overscroll-behavior-y: none; /* é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ */
            -webkit-tap-highlight-color: transparent; 
            -webkit-user-select: none; /* ç¦æ­¢é¸å–æ–‡å­— */
            user-select: none;
            /* è™•ç†ç€æµ·èˆ‡ Home Indicator */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
        }
        
        #root {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å•Ÿå‹•ç‹€æ…‹é¢æ¿ */
        #startup-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #F2F0EB; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #1E3932; padding: 20px; text-align: center; transition: opacity 0.5s;
        }

        /* ç°¡å–®çš„åœ“é¤…åœ– CSS */
        .pie-chart {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(var(--pie-bg));
        }
        
        /* ä¿®æ­£åº•éƒ¨å®‰å…¨å€åŸŸåœ¨æŸäº›èˆŠç‰ˆ iOS çš„è¡¨ç¾ */
        .pb-safe {
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
        }
    </style>
</head>
<body>
    <!-- å•Ÿå‹•ç•«é¢ -->
    <div id="startup-panel">
        <div class="animate-spin h-10 w-10 border-4 border-[#1E3932] border-t-transparent rounded-full mb-4"></div>
        <h1 class="text-2xl font-bold tracking-widest font-serif">æ—¥æ—¥å¸³</h1>
        <p class="text-xs mt-2 opacity-60">è¼‰å…¥æ‚¨çš„ç¾å¥½ç”Ÿæ´»...</p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- å…§å»º Icons (è§£æ±ºè¼‰å…¥éŒ¯èª¤å•é¡Œ) ---
        // ç›´æ¥å®šç¾© SVG å…ƒä»¶ï¼Œä¸ä¾è³´å¤–éƒ¨ script
        const Icon = ({ size = 24, color = "currentColor", className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Icons = {
            Plus: (p) => <Icon {...p}><path d="M5 12h14" /><path d="M12 5v14" /></Icon>,
            Minus: (p) => <Icon {...p}><path d="M5 12h14" /></Icon>,
            Wallet: (p) => <Icon {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h15v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></Icon>,
            PieChart: (p) => <Icon {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10Z" /></Icon>,
            Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></Icon>,
            ChevronLeft: (p) => <Icon {...p}><path d="m15 18-6-6 6-6" /></Icon>,
            ChevronRight: (p) => <Icon {...p}><path d="m9 18 6-6-6-6" /></Icon>,
            BookOpen: (p) => <Icon {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></Icon>,
            Check: (p) => <Icon {...p}><path d="M20 6 9 17l-5-5" /></Icon>,
            Calculator: (p) => <Icon {...p}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></Icon>,
            Save: (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>,
            Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" /></Icon>,
            FileJson: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1" /><path d="M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1" /></Icon>,
            LayoutGrid: (p) => <Icon {...p}><rect width="7" height="7" x="3" y="3" rx="1" /><rect width="7" height="7" x="14" y="3" rx="1" /><rect width="7" height="7" x="14" y="14" rx="1" /><rect width="7" height="7" x="3" y="14" rx="1" /></Icon>,
            ListOrdered: (p) => <Icon {...p}><line x1="10" x2="21" y1="6" y2="6" /><line x1="10" x2="21" y1="12" y2="12" /><line x1="10" x2="21" y1="18" y2="18" /><path d="M4 6h1v4" /><path d="M4 10h2" /><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1" /></Icon>,
            X: (p) => <Icon {...p}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>,
            CreditCard: (p) => <Icon {...p}><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></Icon>,
            Landmark: (p) => <Icon {...p}><line x1="3" x2="21" y1="22" y2="22" /><line x1="6" x2="6" y1="18" y2="11" /><line x1="10" x2="10" y1="18" y2="11" /><line x1="14" x2="14" y1="18" y2="11" /><line x1="18" x2="18" y1="18" y2="11" /><polygon points="12 2 20 7 4 7" /></Icon>,
            Smartphone: (p) => <Icon {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2" /><path d="M12 18h.01" /></Icon>,
            TrendingUp: (p) => <Icon {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></Icon>,
            ArrowRight: (p) => <Icon {...p}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></Icon>,
            Trash2: (p) => <Icon {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></Icon>,
            UserCog: (p) => <Icon {...p}><circle cx="18" cy="15" r="3" /><circle cx="9" cy="7" r="4" /><path d="M10 15H6a4 4 0 0 0-4 4v2" /><path d="m21.7 16.4-.9-.3" /><path d="m15.2 13.9-.9-.3" /><path d="m16.6 18.7.3-.9" /><path d="m19.1 12.2.3-.9" /><path d="m19.6 18.7-.4-1" /><path d="m16.8 12.3-.4-1" /><path d="m14.3 16.6 1-.4" /><path d="m20.7 13.8 1-.4" /></Icon>,
            Info: (p) => <Icon {...p}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></Icon>,
            HelpCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></Icon>,
            Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></Icon>,
            FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></Icon>,
            Book: (p) => <Icon {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" /></Icon>,
            Delete: (p) => <Icon {...p}><path d="M20 5H9l-7 7 7 7h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z" /><line x1="18" x2="12" y1="9" y2="15" /><line x1="12" x2="18" y1="9" y2="15" /></Icon>
        };

        const ACCOUNT_TYPE_CONFIG = {
            cash: { label: 'ç¾é‡‘', icon: Icons.Wallet, color: '#C6A87C' },
            bank: { label: 'éŠ€è¡Œ', icon: Icons.Landmark, color: '#4A6C6F' },
            card: { label: 'ä¿¡ç”¨å¡', icon: Icons.CreditCard, color: '#8C4A32' },
            epay: { label: 'é›»æ”¯', icon: Icons.Smartphone, color: '#1E3932' },
            invest: { label: 'æŠ•è³‡', icon: Icons.TrendingUp, color: '#556B2F' },
        };

        const CURRENCY_CONFIG = {
            'TWD': { label: 'å°å¹£', symbol: 'NT$', flag: 'ğŸ‡¹ğŸ‡¼', digits: 0 },
            'USD': { label: 'ç¾å…ƒ', symbol: 'US$', flag: 'ğŸ‡ºğŸ‡¸', digits: 2 },
            'JPY': { label: 'æ—¥åœ“', symbol: 'Â¥', flag: 'ğŸ‡¯ğŸ‡µ', digits: 0 },
        };

        const DEFAULT_CATEGORIES = [
            { id: 'food', emoji: 'ğŸ™', label: 'é£²é£Ÿ', color: '#8C4A32' },
            { id: 'transport', emoji: 'ğŸšƒ', label: 'äº¤é€š', color: '#4A6C6F' },
            { id: 'shopping', emoji: 'ğŸ›ï¸', label: 'è³¼ç‰©', color: '#C6A87C' },
            { id: 'entertainment', emoji: 'ğŸ¡', label: 'å¨›æ¨‚', color: '#00704A' },
            { id: 'housing', emoji: 'ğŸ ', label: 'å±…å®¶', color: '#5B4839' },
            { id: 'bills', emoji: 'âš¡', label: 'ç¹³è²»', color: '#A67B5B' },
            { id: 'health', emoji: 'ğŸ’Š', label: 'é†«ç™‚', color: '#9E4244' },
            { id: 'education', emoji: 'ğŸ“š', label: 'å­¸ç¿’', color: '#2C4C3B' },
            { id: 'gift', emoji: 'ğŸ', label: 'ç¤¾äº¤', color: '#D9915B' },
            { id: 'investment', emoji: 'ğŸ’¹', label: 'æŠ•è³‡', color: '#6A7062' },
            { id: 'other', emoji: 'âœ¨', label: 'å…¶ä»–', color: '#808080' },
        ];

        // --- å·¥å…· ---
        const SafeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            setItem: (key, value) => { try { localStorage.setItem(key, value); } catch (e) {} },
            clear: () => { try { localStorage.clear(); } catch(e) {} }
        };

        const formatCurrency = (amount, currencyCode = 'TWD') => {
            const config = CURRENCY_CONFIG[currencyCode] || CURRENCY_CONFIG['TWD'];
            try {
                const num = new Intl.NumberFormat(currencyCode === 'TWD' || currencyCode === 'JPY' ? 'zh-TW' : 'en-US', {
                    minimumFractionDigits: config.digits, maximumFractionDigits: config.digits
                }).format(amount || 0);
                return `${config.symbol} ${num}`;
            } catch(e) { return `${amount}`; }
        };

        const getTodayString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatDate = (d) => {
            try {
                const date = new Date(d);
                return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            } catch { return d; }
        };
        const getGreeting = () => { const h = new Date().getHours(); return h<12?'æ—©å®‰':h<18?'åˆå®‰':'æ™šå®‰'; };

        // --- å…ƒä»¶ ---
        const SafeInput = ({ value, onChange, placeholder, className, autoFocus, type='text', inputRef }) => {
            return <input ref={inputRef} type={type} value={value} className={className} placeholder={placeholder} autoFocus={autoFocus} onChange={(e)=>onChange(e.target.value)} />;
        };

        const CalculatorPad = ({ onValueChange, onConfirm }) => {
            const [display, setDisplay] = useState('');
            const handlePress = (key) => {
                if (key === 'C') { setDisplay(''); onValueChange(''); } 
                else if (key === 'âŒ«') { const n=display.slice(0,-1); setDisplay(n); if(!isNaN(parseFloat(n))||n==='') onValueChange(n); } 
                else if (key === '=') { try { const r=new Function('return '+display.replace(/Ã—/g,'*').replace(/Ã·/g,'/'))().toString(); const final=r.includes('.')?parseFloat(r).toFixed(2):r; setDisplay(final); onValueChange(final); } catch { setDisplay('Error'); } }
                else { setDisplay(display + key); }
            };
            const keys = ['7', '8', '9', 'Ã·', '4', '5', '6', 'Ã—', '1', '2', '3', '-', 'C', '0', '.', '+'];
            return (
                <div className="bg-[#1E3932] p-4 rounded-3xl border-4 border-[#C6A87C] shadow-2xl relative z-50 mb-4 animate-in slide-in-from-bottom-5">
                    <div className="flex justify-between items-center mb-3 px-1"><span className="text-[#C6A87C] font-bold text-xs tracking-widest">CALCULATOR</span><div className="h-10 bg-[#F2F0EB] rounded-lg px-3 flex items-center justify-end w-40 font-mono text-xl text-[#1E3932] overflow-hidden">{display||'0'}</div></div>
                    <div className="grid grid-cols-4 gap-3">
                        {keys.map(k=><button key={k} onClick={()=>handlePress(k)} className={`h-12 rounded-xl text-xl font-bold shadow-md active:scale-90 transition-transform ${['Ã·','Ã—','-','+'].includes(k)?'bg-[#C6A87C] text-[#1E3932]':'bg-[#F2F0EB] text-[#1E3932]'} ${k==='C'?'bg-[#8C4A32] text-white':''}`}>{k}</button>)}
                        <button onClick={()=>handlePress('âŒ«')} className="col-span-2 h-12 rounded-xl bg-[#5B665E] text-white font-bold flex items-center justify-center active:scale-95"><Icons.Delete size={24}/></button>
                        <button onClick={()=>{handlePress('=');setTimeout(onConfirm,200);}} className="col-span-2 h-12 rounded-xl bg-white text-[#1E3932] font-bold flex items-center justify-center active:scale-95 border-2 border-[#C6A87C]">å®Œæˆ</button>
                    </div>
                </div>
            );
        };

        const SystemDialog = ({ isOpen, type, title, message, onConfirm, onCancel, isDanger }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center px-6 animate-in fade-in duration-200">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onCancel}></div>
                    <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative z-10 flex flex-col items-center text-center">
                        <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-4 ${isDanger?'bg-red-100 text-red-500':'bg-[#EBF5F0] text-[#1E3932]'}`}>{type==='confirm'?<Icons.HelpCircle size={32}/>:<Icons.Info size={32}/>}</div>
                        <h3 className="text-xl font-bold text-[#1E3932] mb-2">{title}</h3><p className="text-sm text-[#5B665E] mb-6 leading-relaxed">{message}</p>
                        <div className="flex gap-3 w-full">
                            {type==='confirm'&&(<button onClick={onCancel} className="flex-1 py-3 rounded-xl border-2 border-[#E5E5E5] text-[#888] font-bold active:bg-gray-50 transition-colors">å–æ¶ˆ</button>)}
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-all ${isDanger?'bg-red-500 shadow-red-200':'bg-[#1E3932] shadow-[#1E3932]/30'}`}>{type==='confirm'?(isDanger?'åˆªé™¤':'ç¢ºå®š'):'çŸ¥é“äº†'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const AccountSelector = ({ accounts, selectedId, onSelect, label }) => {
            const [viewState, setViewState] = useState('category');
            const [selectedCategory, setSelectedCategory] = useState(null);
            
            useEffect(() => { 
                if (!selectedId) { setViewState('category'); setSelectedCategory(null); }
            }, [selectedId]);

            const selectedAccount = accounts.find(a => a.id === selectedId);

            if (selectedAccount) {
                const config = ACCOUNT_TYPE_CONFIG[selectedAccount.type] || ACCOUNT_TYPE_CONFIG.cash;
                const currency = CURRENCY_CONFIG[selectedAccount.currency || 'TWD'];
                return (
                    <div className="mb-6 animate-in fade-in slide-in-from-bottom-2">
                        <label className="block text-xs font-bold text-[#5B665E] mb-2 pl-1 tracking-widest text-center">- {label} -</label>
                        <button onClick={() => onSelect('')} className="w-full bg-[#1E3932] p-4 rounded-2xl shadow-md flex items-center justify-between group active:scale-95 transition-all">
                            <div className="flex items-center gap-3 text-white">
                                <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><Icons.Check size={20}/></div>
                                <div className="text-left"><p className="text-sm font-bold">{selectedAccount.name}</p><p className="text-xs opacity-70">{currency.flag} {config.label}</p></div>
                            </div>
                            <div className="bg-white/20 px-3 py-1 rounded-full text-[10px] text-white font-bold">æ›´æ›</div>
                        </button>
                    </div>
                );
            }
            if (viewState === 'list' && selectedCategory) {
                const config = ACCOUNT_TYPE_CONFIG[selectedCategory];
                const filteredAccounts = accounts.filter(a => a.type === selectedCategory);
                return (
                    <div className="mb-6 animate-in slide-in-from-right-4 fade-in duration-200">
                        <div className="flex items-center justify-between mb-3 px-1">
                            <button onClick={() => setViewState('category')} className="text-xs font-bold text-[#888] flex items-center gap-1 hover:text-[#1E3932]"><Icons.ChevronLeft size={14}/> è¿”å›é¡åˆ¥</button>
                            <span className="text-sm font-bold text-[#1E3932] tracking-widest flex items-center gap-2">{config.icon && <config.icon size={16}/>} {config.label}</span>
                            <div className="w-10"></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            {filteredAccounts.length > 0 ? filteredAccounts.map(acc => { 
                                const accCur = CURRENCY_CONFIG[acc.currency || 'TWD']; 
                                return (<button key={acc.id} onClick={() => onSelect(acc.id)} className="bg-white p-3 rounded-xl border border-[#D4D9D5] shadow-sm flex flex-col items-start gap-1 active:scale-95 active:bg-gray-50"><span className="text-xl mb-1">{accCur.flag}</span><span className="text-sm font-bold text-[#1E3932] line-clamp-1">{acc.name}</span></button>) 
                            }) : <div className="col-span-2 text-center py-6 text-[#888] text-xs bg-white rounded-xl border border-dashed border-[#D4D9D5]">æ­¤é¡åˆ¥å°šç„¡å¸³æˆ¶</div>}
                        </div>
                    </div>
                );
            }
            return (
                <div className="mb-6">
                    <label className="block text-xs font-bold text-[#5B665E] mb-3 pl-1 tracking-widest text-center">- {label} -</label>
                    <div className="grid grid-cols-3 gap-3">
                        {Object.entries(ACCOUNT_TYPE_CONFIG).map(([key, config]) => (
                            <button key={key} onClick={() => { setSelectedCategory(key); setViewState('list'); }} className="bg-white p-3 rounded-xl border border-[#D4D9D5] shadow-sm flex flex-col items-center justify-center gap-2 active:border-[#1E3932] active:text-[#1E3932] text-[#5B665E] transition-all active:scale-95 h-20">
                                {config.icon && <config.icon size={20}/>}<span className="text-xs font-bold">{config.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- ä¸»ç¨‹å¼ ---
        const App = () => {
            const [transactions, setTransactions] = useState(() => { try { return JSON.parse(SafeStorage.getItem('nichinichi_txs')) || []; } catch { return []; } });
            const [accounts, setAccounts] = useState(() => { try { return JSON.parse(SafeStorage.getItem('nichinichi_accs')) || []; } catch { return []; } });
            const [categories, setCategories] = useState(() => { try { return JSON.parse(SafeStorage.getItem('nichinichi_cats')) || []; } catch { return []; } });
            const [lastBackup, setLastBackup] = useState(() => SafeStorage.getItem('nichinichi_last_backup') || null);

            // å„²å­˜é‚è¼¯
            useEffect(() => SafeStorage.setItem('nichinichi_txs', JSON.stringify(transactions)), [transactions]);
            useEffect(() => SafeStorage.setItem('nichinichi_accs', JSON.stringify(accounts)), [accounts]);
            useEffect(() => SafeStorage.setItem('nichinichi_cats', JSON.stringify(categories)), [categories]);
            useEffect(() => { if(lastBackup) SafeStorage.setItem('nichinichi_last_backup', lastBackup) }, [lastBackup]);

            useEffect(() => {
                // åˆå§‹åŒ–é è¨­è³‡æ–™
                if (accounts.length === 0) setAccounts([{ id: '1', name: 'ç¾é‡‘éŒ¢åŒ…', type: 'cash', currency: 'TWD', createdAt: new Date() }]);
                if (categories.length === 0) setCategories(DEFAULT_CATEGORIES.map(c => ({...c, createdAt: new Date()})));
                
                // éš±è— Loading
                setTimeout(() => {
                    const loader = document.getElementById('startup-panel');
                    if(loader) loader.style.display = 'none';
                }, 800);
            }, []);

            const [activeTab, setActiveTab] = useState('portal');
            const [selAssetCat, setSelectedAssetCategory] = useState(null);
            
            // è¨˜å¸³ç‹€æ…‹
            const [amount, setAmount] = useState(''); 
            const [note, setNote] = useState(''); 
            const [selCatId, setSelCatId] = useState('');
            const [selAccId, setSelAccId] = useState(''); 
            const [toAccId, setToAccId] = useState('');
            const [type, setType] = useState('expense'); 
            const [date, setDate] = useState(getTodayString());
            const [showCalc, setShowCalc] = useState(false);
            const amountInputRef = useRef(null);

            // å°è©±æ¡†èˆ‡ Modal
            const [dialogConfig, setDialogConfig] = useState({ isOpen: false, type: 'alert', title: '', message: '', onConfirm: () => {}, isDanger: false });
            const [isAddingAccountModalOpen, setIsAddingAccountModalOpen] = useState(false);
            const [isManualModalOpen, setIsManualModalOpen] = useState(false);
            const [newAccountName, setNewAccountName] = useState(''); 
            const [newAccountType, setNewAccountType] = useState('bank'); 
            const [newAccountCurrency, setNewAccountCurrency] = useState('TWD');
            const [isManagingCategories, setIsManagingCategories] = useState(false);
            const [newCategoryName, setNewCategoryName] = useState(''); 
            const [newCategoryEmoji, setNewCategoryEmoji] = useState('ğŸŒŸ');

            const showAlert = (title, message) => setDialogConfig({ isOpen: true, type: 'alert', title, message, onConfirm: () => setDialogConfig(prev => ({...prev, isOpen: false})) });
            const showConfirm = (title, message, onConfirm, isDanger = false) => setDialogConfig({ isOpen: true, type: 'confirm', title, message, isDanger, onConfirm: () => { onConfirm(); setDialogConfig(prev => ({...prev, isOpen: false})); }, onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false})) });

            // æ ¸å¿ƒåŠŸèƒ½
            const handleAddTransaction = () => {
                if(!amount) return;
                const newTx = { id: Date.now().toString(), amount: Number(amount), type, note, date, accountId: selAccId, category: selCatId, toAccountId: type==='transfer'?toAccId:null, createdAt: new Date().toISOString() };
                setTransactions(prev => [newTx, ...prev]); 
                setAmount(''); setNote(''); setShowCalc(false);
                if (type !== 'transfer' && categories.length > 0) setSelCatId(categories[0].id); 
                setActiveTab('home');
            };
            
            const delTx = (id) => showConfirm('åˆªé™¤', 'ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ', () => setTransactions(prev => prev.filter(t=>t.id!==id)), true);
            
            const addAcc = () => {
                if(!newAccountName) return;
                const newAcc = { id: Date.now().toString(), name: newAccountName, type: newAccountType, currency: newAccountCurrency, createdAt: new Date().toISOString() };
                setAccounts(prev => [...prev, newAcc]); setIsAddingAccountModalOpen(false); setNewAccountName(''); 
                if(!selAssetCat) setSelectedAssetCategory(newAccountType);
            };
            const delAcc = (id) => showConfirm('åˆªé™¤å¸³æˆ¶', 'ç¢ºå®šåˆªé™¤ï¼Ÿ', () => setAccounts(prev => prev.filter(a=>a.id!==id)), true);
            
            const handleAddCategory = () => { if(!newCategoryName)return; setCategories(prev=>[...prev,{id:Date.now().toString(),label:newCategoryName,emoji:newCategoryEmoji,color:'#808080',createdAt:new Date().toISOString()}]); setNewCategoryName(''); setIsManagingCategories(false); };
            const handleDeleteCategory = (id) => showConfirm('åˆªé™¤åˆ†é¡', 'ç¢ºå®šåˆªé™¤ï¼Ÿ', () => setCategories(prev => prev.filter(c=>c.id!==id)), true);
            
            const clearData = () => showConfirm('æ¸…ç©º', 'ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿç„¡æ³•å¾©åŸï¼', () => { SafeStorage.clear(); window.location.reload(); }, true);

            // å‚™ä»½èˆ‡åŒ¯å‡º
            const handleBackupJSON = () => {
                const data = { version: "3.5", date: new Date().toISOString(), data: { accounts, categories, transactions } };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
                setLastBackup(new Date().toLocaleString());
            };
            const handleRestoreJSON = (e) => {
                const file = e.target.files[0]; if(!file) return;
                showConfirm('é‚„åŸ', 'é‚„åŸå°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œå»ºè­°å…ˆå‚™ä»½ã€‚ç¢ºå®šï¼Ÿ', () => {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try { const d = JSON.parse(ev.target.result); if(d.data){ setAccounts(d.data.accounts||[]); setCategories(d.data.categories||[]); setTransactions(d.data.transactions||[]); showAlert('æˆåŠŸ','é‚„åŸå®Œæˆ'); } } catch{ showAlert('éŒ¯èª¤','æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                    };
                    r.readAsText(file);
                }, true);
            };

            // è¨ˆç®—é‚è¼¯
            const bals = useMemo(() => {
                const tot = {'TWD':0, 'USD':0, 'JPY':0}; const b={};
                accounts.forEach(a=>b[a.id]=0);
                transactions.forEach(t=>{
                    if(b[t.accountId]!==undefined) { if(t.type==='income') b[t.accountId]+=t.amount; else b[t.accountId]-=t.amount; }
                    if(t.type==='transfer' && b[t.toAccountId]!==undefined) b[t.toAccountId]+=t.amount;
                });
                accounts.forEach(a=>{ if(tot[a.currency]!==undefined) tot[a.currency]+=b[a.id]; });
                return {b, tot};
            }, [transactions, accounts]);

            const groupedTransactions = useMemo(() => {
                const g = {};
                transactions.forEach(t => { if(!g[t.date]) g[t.date]=[]; g[t.date].push(t); });
                return Object.entries(g).sort((a,b) => new Date(b[0]) - new Date(a[0]));
            }, [transactions]);
            
            // å ±è¡¨åˆ†æè³‡æ–™
            const analysisData = useMemo(() => {
                const now = new Date();
                const currentMonthStr = now.toISOString().slice(0, 7); // YYYY-MM
                const catMap = {}; let totalExp = 0;
                
                transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonthStr)).forEach(t => {
                    totalExp += t.amount;
                    const c = categories.find(ca => ca.id === t.category) || DEFAULT_CATEGORIES.find(dc => dc.id === t.category);
                    const name = c ? c.label : 'å…¶ä»–';
                    const color = c ? c.color : '#888';
                    if (!catMap[name]) catMap[name] = { val: 0, color }; 
                    catMap[name].val += t.amount;
                });
                
                const sorted = Object.entries(catMap).sort((a,b) => b[1].val - a[1].val).map(([k,v]) => ({ key:k, ...v }));
                
                // ç”¢ç”Ÿ Conic Gradient
                let gradientStr = ''; let currentDeg = 0;
                if(totalExp > 0) {
                     sorted.forEach((item, idx) => {
                         const deg = (item.val / totalExp) * 360;
                         gradientStr += `${item.color} ${currentDeg}deg ${currentDeg + deg}deg${idx === sorted.length - 1 ? '' : ','}`;
                         currentDeg += deg;
                     });
                } else {
                    gradientStr = '#E5E5E5 0deg 360deg';
                }

                return { sorted, totalExp, gradientStr, currentMonthStr };
            }, [transactions, categories]);

            // --- è¦–åœ–å…ƒä»¶ ---
            const Portal = () => (
                <div className="flex-1 overflow-y-auto px-6 pb-28 pt-2 no-scrollbar">
                    <div onClick={()=>setActiveTab('assets')} className="bg-[#1E3932] rounded-2xl p-6 shadow-lg mb-8 text-[#F2F0EB] active:scale-[0.98] transition-transform">
                         <p className="text-xs font-bold opacity-80 mb-1">ğŸ‡¹ğŸ‡¼ å°å¹£ç¸½è³‡ç”¢</p>
                         <h2 className="text-3xl font-serif font-bold">{formatCurrency(bals.tot['TWD'], 'TWD')}</h2>
                         <div className="grid grid-cols-2 gap-4 border-t border-white/10 pt-4 mt-4">
                            <div><p className="text-xs opacity-60">ğŸ‡ºğŸ‡¸ ç¾å…ƒ</p><p className="font-bold">{formatCurrency(bals.tot['USD'], 'USD')}</p></div>
                            <div><p className="text-xs opacity-60">ğŸ‡¯ğŸ‡µ æ—¥åœ“</p><p className="font-bold">{formatCurrency(bals.tot['JPY'], 'JPY')}</p></div>
                         </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={()=>{ setType('expense'); setActiveTab('add'); }} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-center gap-2 active:bg-gray-50"><div className="w-12 h-12 bg-[#C6A87C] rounded-full flex items-center justify-center text-white"><Icons.Plus/></div><span className="font-bold text-[#1E3932]">è¨˜ä¸€ç­†</span></button>
                        <button onClick={()=>setActiveTab('home')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-center gap-2 active:bg-gray-50"><div className="w-12 h-12 bg-[#4A6C6F] rounded-full flex items-center justify-center text-white"><Icons.BookOpen/></div><span className="font-bold text-[#1E3932]">çœ‹å¸³æœ¬</span></button>
                        <button onClick={()=>setActiveTab('analysis')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-center gap-2 active:bg-gray-50"><div className="w-12 h-12 bg-[#00704A] rounded-full flex items-center justify-center text-white"><Icons.PieChart/></div><span className="font-bold text-[#1E3932]">çœ‹å ±è¡¨</span></button>
                        <button onClick={()=>setActiveTab('assets')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-center gap-2 active:bg-gray-50"><div className="w-12 h-12 bg-[#8C4A32] rounded-full flex items-center justify-center text-white"><Icons.Wallet/></div><span className="font-bold text-[#1E3932]">ç®¡éŒ¢åŒ…</span></button>
                    </div>
                    <div className="mt-8">
                       <h3 className="text-[#5B665E] font-bold text-lg mb-4 tracking-wider">æœ€è¿‘ç´€éŒ„</h3>
                       <div className="space-y-3">
                           {transactions.length === 0 ? <p className="text-center text-gray-400 text-sm py-4">å°šç„¡ç´€éŒ„</p> : 
                            transactions.slice(0, 3).map(item => { 
                              const acc = accounts.find(a => a.id === item.accountId); const currency = acc ? (acc.currency || 'TWD') : 'TWD';
                              const cat = categories.find(c => c.id === item.category) || DEFAULT_CATEGORIES.find(c => c.id === item.category);
                              return (<div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-[#E0E0E0] flex items-center justify-between"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-[#F5F5F5] flex items-center justify-center text-lg">{cat?.emoji || 'ğŸ“'}</div><div><p className="font-bold text-[#1E3932] line-clamp-1">{item.note || cat?.label || 'ç„¡å‚™è¨»'}</p><p className="text-xs text-[#888]">{formatDate(item.date)}</p></div></div><span className={`font-bold ${item.type==='expense'?'text-[#8C4A32]':item.type==='income'?'text-[#00704A]':'text-gray-600'}`}>{item.type==='expense'?'-':item.type==='income'?'+':''}{formatCurrency(item.amount, currency)}</span></div>)
                           })}
                       </div>
                    </div>
                </div>
            );

            const AssetsView = () => {
                if(selAssetCat) {
                    const list = accounts.filter(a=>a.type===selAssetCat);
                    return <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 no-scrollbar animate-in slide-in-from-right-8"><div className="flex items-center gap-2 mb-4"><button onClick={()=>setSelectedAssetCategory(null)} className="p-2 -ml-2 text-gray-500"><Icons.ChevronLeft/></button><h2 className="text-xl font-bold">{ACCOUNT_TYPE_CONFIG[selAssetCat].label}</h2></div><button onClick={()=>{setNewAccountType(selAssetCat);setIsAddingAccountModalOpen(true)}} className="w-full py-4 mb-4 border-2 border-dashed border-[#8FA79A] rounded-2xl font-bold text-[#1E3932] flex justify-center items-center gap-2 active:bg-[#EBF5F0] transition-colors"><Icons.Plus/>æ–°å¢å¸³æˆ¶</button><div className="grid gap-3">{list.map(a=><div key={a.id} className="bg-white p-5 rounded-2xl shadow-sm border border-[#E0E0E0] flex justify-between items-center"><div><h4 className="font-bold text-[#1E3932]">{a.name}</h4><p className="text-xs text-gray-500">{formatCurrency(bals.b[a.id], a.currency)}</p></div><button onClick={()=>delAcc(a.id)} className="text-red-300 p-2"><Icons.Trash2 size={18}/></button></div>)}</div></div>
                }
                return <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 no-scrollbar"><div className="bg-[#1E3932] rounded-[2rem] p-8 shadow-lg mb-8 text-[#F2F0EB]"><div><p className="text-sm opacity-80 mb-2 font-bold tracking-widest">ğŸ‡¹ğŸ‡¼ å°å¹£ç¸½è³‡ç”¢</p><h2 className="text-4xl font-serif font-bold tracking-wide">{formatCurrency(bals.tot['TWD'], 'TWD')}</h2></div></div><h3 className="text-[#5B665E] font-bold text-lg mb-4 flex items-center gap-2"><Icons.Wallet size={20}/> åˆ†é¡</h3><div className="grid gap-4">{Object.entries(ACCOUNT_TYPE_CONFIG).map(([k,c])=><button key={k} onClick={()=>setSelectedAssetCategory(k)} className="bg-white rounded-2xl p-5 shadow-sm border border-[#E0E0E0] flex justify-between items-center active:scale-[0.98] transition-transform"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center" style={{color:c.color}}>{c.icon && <c.icon size={24}/>}</div><span className="font-bold text-[#1E3932]">{c.label}</span></div><Icons.ChevronRight className="text-gray-300"/></button>)}</div></div>;
            };

            const AnalysisView = () => {
                const { sorted, totalExp, gradientStr, currentMonthStr } = analysisData;
                return (
                    <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 no-scrollbar">
                        <div className="bg-white rounded-3xl p-6 shadow-sm border border-[#E5E5E5] mb-6 flex flex-col items-center">
                             <h3 className="text-[#5B665E] font-bold mb-6 text-sm tracking-widest">{currentMonthStr} æ”¯å‡ºåˆ†æ</h3>
                             <div className="pie-chart shadow-inner mb-6" style={{'--pie-bg': gradientStr}}></div>
                             <div className="text-center">
                                 <p className="text-xs text-gray-400 font-bold mb-1">æœ¬æœˆç¸½æ”¯å‡º</p>
                                 <p className="text-3xl font-serif font-bold text-[#1E3932]">{formatCurrency(totalExp)}</p>
                             </div>
                        </div>
                        <h3 className="font-bold text-[#1E3932] mb-4">æ”¯å‡ºæ’è¡Œ</h3>
                        <div className="space-y-4">
                            {sorted.length > 0 ? sorted.map((item) => (
                                <div key={item.key} className="flex items-center gap-3">
                                    <div className="w-2 h-10 rounded-full" style={{backgroundColor: item.color}}></div>
                                    <div className="flex-1">
                                        <div className="flex justify-between mb-1">
                                            <span className="font-bold text-sm text-[#5B665E]">{item.key}</span>
                                            <span className="font-bold text-sm">{formatCurrency(item.val)}</span>
                                        </div>
                                        <div className="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                            <div className="h-full rounded-full" style={{width: `${(item.val / totalExp) * 100}%`, backgroundColor: item.color}}></div>
                                        </div>
                                    </div>
                                </div>
                            )) : <p className="text-center text-gray-400 text-sm">æœ¬æœˆå°šç„¡æ”¯å‡ºç´€éŒ„</p>}
                        </div>
                    </div>
                )
            };

            const AddView = () => {
                const toggleCalc = () => { if(!showCalc) amountInputRef.current?.blur(); setShowCalc(!showCalc); };
                const cur = accounts.find(a=>a.id===selAccId)?.currency || 'TWD';
                const isSubmitting = false;

                return (
                    <div className="absolute inset-0 bg-[#F2F0EB] z-50 flex flex-col animate-in slide-in-from-bottom-10 duration-300">
                        <div className="pt-12 px-6 pb-4 flex justify-between items-center">
                            <button onClick={()=>setActiveTab('portal')} className="p-2 -ml-2"><Icons.X/></button>
                            <div className="flex gap-2 bg-white rounded-full p-1 shadow-sm">
                                {['expense','income','transfer'].map(k=>
                                    <button key={k} onClick={()=>setType(k)} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${type===k?'bg-[#1E3932] text-white shadow-md':'text-gray-400'}`}>
                                        {k==='transfer'?'è½‰å¸³':k==='expense'?'æ”¯å‡º':'æ”¶å…¥'}
                                    </button>
                                )}
                            </div>
                            <div className="w-8"></div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-6 py-4 no-scrollbar">
                            <div className="mb-4 text-center">
                                <div className="relative inline-block w-full">
                                    <span className="absolute left-0 top-1/2 -translate-y-1/2 text-xl font-bold flex items-center gap-1 text-[#C6A87C]">{CURRENCY_CONFIG[cur].symbol}</span>
                                    <input ref={amountInputRef} type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0" className="w-full text-center text-6xl font-serif font-extrabold bg-transparent outline-none text-[#1E3932] py-2 pl-8 placeholder-gray-200" inputMode="decimal" />
                                </div>
                                <div className="flex justify-center mt-2"><button onClick={toggleCalc} className="flex items-center gap-2 px-6 py-2 rounded-full bg-white border border-[#D4D9D5] text-sm font-bold text-[#1E3932] shadow-sm active:scale-95 transition-transform"><Icons.Calculator size={16}/>è¨ˆç®—æ©Ÿ</button></div>
                            </div>
                            {showCalc && <CalculatorPad onValueChange={setAmount} onConfirm={()=>setShowCalc(false)} />}
                            
                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-[#E5E5E5] mb-24">
                            {type==='transfer' ? (
                                <div className="space-y-6">
                                    <AccountSelector accounts={accounts} selectedId={selAccId} onSelect={setSelAccId} label="è½‰å‡ºå¸³æˆ¶"/>
                                    <div className="flex justify-center text-[#C6A87C]"><Icons.ArrowRight/></div>
                                    <AccountSelector accounts={accounts} selectedId={toAccId} onSelect={setToAccId} label="è½‰å…¥å¸³æˆ¶"/>
                                </div>
                            ) : (
                                <>
                                  <AccountSelector accounts={accounts} selectedId={selAccId} onSelect={setSelAccId} label="æ”¯ä»˜å¸³æˆ¶"/>
                                  <div className="mb-8">
                                    <div className="flex justify-between items-center mb-4 px-2"><label className="text-xs font-bold text-[#5B665E] tracking-widest">- é¸æ“‡åˆ†é¡ -</label><button onClick={()=>setIsManagingCategories(!isManagingCategories)} className="text-xs font-bold text-[#C6A87C] flex items-center gap-1"><Icons.Settings size={12} /> ç®¡ç†</button></div>
                                    {isManagingCategories ? (
                                        <div className="bg-gray-50 p-4 rounded-2xl border-2 border-[#D4D9D5] mb-4 animate-in slide-in-from-top-2">
                                            <h4 className="font-bold text-[#1E3932] mb-3 text-center text-sm">æ–°å¢åˆ†é¡</h4>
                                            <div className="flex gap-2 mb-3">
                                                <input type="text" value={newCategoryEmoji} onChange={e => setNewCategoryEmoji(e.target.value)} className="w-12 text-center bg-white rounded-lg p-2 text-xl shadow-sm border border-gray-200" placeholder="Emoji" />
                                                <SafeInput value={newCategoryName} onChange={setNewCategoryName} className="flex-1 bg-white rounded-lg p-2 text-sm font-bold text-gray-800 border border-gray-200 focus:border-[#1E3932] outline-none transition-colors" placeholder="åˆ†é¡åç¨±" />
                                                <button onClick={handleAddCategory} className="bg-[#1E3932] text-white px-4 rounded-lg font-bold text-xs shadow-sm">æ–°å¢</button>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2 mt-4 max-h-40 overflow-y-auto">
                                                {categories.map(cat => (
                                                    <div key={cat.id} className="relative group border bg-white rounded-lg p-2 flex flex-col items-center shadow-sm">
                                                        <span className="text-xl">{cat.emoji}</span>
                                                        <span className="text-[10px] mt-1 truncate w-full text-center font-bold text-gray-600">{cat.label}</span>
                                                        <button onClick={() => handleDeleteCategory(cat.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center shadow-md"><Icons.X size={12} /></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-4 gap-3">
                                            {(categories.length>0?categories:DEFAULT_CATEGORIES).map(c=>
                                                <button key={c.id} onClick={()=>setSelCatId(c.id)} className={`flex flex-col items-center gap-1 p-3 rounded-2xl border-2 active:scale-95 transition-all aspect-square justify-center ${selCatId===c.id?'bg-[#F2F0EB] border-[#1E3932] text-[#1E3932]':'bg-white border-transparent text-[#888]'}`}>
                                                    <div className="text-2xl mb-1">{c.emoji}</div>
                                                    <span className="text-[10px] font-bold">{c.label}</span>
                                                </button>
                                            )}
                                            <button onClick={()=>setIsManagingCategories(true)} className="flex flex-col items-center justify-center gap-1 p-3 rounded-2xl border-2 border-dashed border-gray-300 text-gray-400 hover:bg-white hover:border-[#1E3932] hover:text-[#1E3932] transition-colors aspect-square">
                                                <Icons.Plus size={24}/>
                                            </button>
                                        </div>
                                    )}
                                  </div>
                                </>
                            )}
                            <div className="space-y-4">
                                <div className="bg-gray-50 p-3 rounded-xl flex items-center gap-4 border border-gray-200"><Icons.Calendar className="text-gray-400"/><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="flex-1 bg-transparent text-sm font-bold text-[#1E3932] outline-none" /></div>
                                <div className="bg-gray-50 p-3 rounded-xl flex items-center gap-4 border border-gray-200"><span className="text-gray-400 text-sm font-serif font-bold pl-1">è¨»</span><SafeInput value={note} onChange={setNote} placeholder={type === 'transfer' ? "ä¾‹å¦‚ï¼šè²·ç¾è‚¡" : "å¯«é»ä»€éº¼..."} className="flex-1 bg-transparent text-sm font-bold text-gray-800 outline-none placeholder-gray-400" /></div>
                            </div>
                            </div>
                        </div>
                        <div className="fixed bottom-0 w-full max-w-2xl bg-white p-6 shadow-[0_-5px_25px_rgba(0,0,0,0.05)] border-t border-[#F5F5F5] pb-safe">
                          <button onClick={handleAddTransaction} disabled={!amount || isSubmitting} className={`w-full py-4 rounded-2xl text-white text-lg font-bold tracking-widest shadow-xl transform transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${type === 'expense' ? 'bg-[#8C4A32] shadow-[#8C4A32]/30' : type === 'income' ? 'bg-[#00704A] shadow-[#00704A]/30' : 'bg-[#1E3932] shadow-[#1E3932]/30'}`}>{isSubmitting ? 'ç´€éŒ„ä¸­...' : type === 'transfer' ? 'ç¢ºèªè½‰å¸³' : 'ç¢ºèªè¨˜å¸³'}</button>
                        </div>
                    </div>
                );
            };

            const SettingsView = () => (
                <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 space-y-6 no-scrollbar">
                    <button onClick={()=>setIsManualModalOpen(true)} className="w-full p-6 bg-[#1E3932] text-white rounded-3xl shadow-lg flex justify-between items-center active:scale-[0.98] transition-transform"><div><p className="font-bold text-lg">ä½¿ç”¨èªªæ˜æ›¸</p><p className="text-xs opacity-70">é›¢ç·šç‰ˆ v3.5</p></div><Icons.Book/></button>
                    <div className="bg-white p-5 rounded-3xl border border-[#E5E5E5] shadow-sm"><h4 className="font-bold text-[#5B665E] mb-4 flex items-center gap-2"><Icons.Save size={18}/> è³‡æ–™å‚™ä»½ (JSON)</h4><div className="grid gap-3"><button onClick={handleBackupJSON} className="p-4 bg-gray-50 rounded-xl text-left font-bold text-[#1E3932] flex justify-between active:bg-gray-100">ä¸‹è¼‰å‚™ä»½ <Icons.Download size={18}/></button><div className="relative"><input type="file" className="hidden" id="import-file" onChange={handleRestoreJSON}/><button onClick={()=>document.getElementById('import-file').click()} className="w-full p-4 bg-gray-50 rounded-xl text-left font-bold text-[#1E3932] flex justify-between active:bg-gray-100">é‚„åŸå‚™ä»½ <Icons.Upload size={18}/></button></div></div></div>
                    <button onClick={clearData} className="w-full p-4 bg-red-50 text-red-500 rounded-2xl font-bold flex justify-center items-center gap-2 active:bg-red-100 transition-colors"><Icons.Trash2 size={18}/> æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                    <div className="text-center py-4 text-xs text-gray-300">
                         Made for iPhone
                    </div>
                </div>
            );

            const Header = ({ title, subtitle, showGreeting, showBackToPortal, onBack }) => (
                <div className="pt-8 pb-4 px-6 sticky top-0 bg-[#F2F0EB] z-10 w-full transition-all">
                   <div className="flex justify-between items-end">
                      <div className="flex items-center gap-3">
                          {showBackToPortal && <button onClick={onBack || (() => setActiveTab('portal'))} className="p-2 -ml-2 text-[#1E3932]"><Icons.ChevronLeft size={28}/></button>}
                          <div>
                             {showGreeting && <p className="text-xs font-bold text-[#888] tracking-widest mb-1">{getGreeting()}ï¼Œæ—¥æ—¥å¥½æ—¥</p>}
                             <h1 className="text-3xl font-serif font-extrabold text-[#1E3932]">{title}</h1>
                          </div>
                       </div>
                       {subtitle && <div className="text-xs font-bold text-[#1E3932] bg-white px-3 py-1 rounded-full shadow-sm border border-[#D4D9D5]">{subtitle}</div>}
                   </div>
                </div>
            );

            // --- App Render ---
            return (
                <div className="h-full w-full bg-[#F2F0EB] text-[#1E3932] md:max-w-2xl md:mx-auto md:shadow-2xl relative flex flex-col">
                    {activeTab !== 'add' && <Header title={activeTab==='portal'?'æ—¥æ—¥å¸³':activeTab==='settings'?'è¨­å®š':activeTab==='home'?'å¸³æœ¬':activeTab==='analysis'?'å ±è¡¨':'è³‡ç”¢'} showGreeting={activeTab==='portal'} showBackToPortal={activeTab!=='portal'} />}
                    {activeTab === 'portal' && <Portal />}
                    {activeTab === 'home' && (
                        <div className="flex-1 overflow-y-auto px-6 pb-28 no-scrollbar">
                            {groupedTransactions.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                                    <Icons.BookOpen size={48} />
                                    <p className="mt-4 text-sm font-bold">ç›®å‰æ²’æœ‰å¸³ç›®ç´€éŒ„</p>
                                    <button onClick={() => { setType('expense'); setActiveTab('add'); }} className="mt-4 px-6 py-2 bg-[#1E3932] text-white rounded-full text-xs font-bold shadow-lg active:scale-95 transition-transform">
                                        é–‹å§‹è¨˜å¸³
                                    </button>
                                </div>
                            ) : (
                                groupedTransactions.map(([d, txs]) => (
                                    <div key={d} className="mb-6">
                                        <h3 className="text-xs font-bold text-gray-400 mb-2 pl-1 sticky top-0 bg-[#F2F0EB] py-2">{formatDate(d)}</h3>
                                        <div className="space-y-3">
                                            {txs.map(t => {
                                                const acc = accounts.find(a => a.id === t.accountId);
                                                const currency = acc ? (acc.currency || 'TWD') : 'TWD';
                                                const cat = categories.find(c => c.id === t.category) || DEFAULT_CATEGORIES.find(dc => dc.id === t.category);
                                                return (
                                                    <div key={t.id} className="bg-white p-4 rounded-2xl shadow-sm border border-[#E0E0E0] flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-10 h-10 rounded-full bg-[#F5F5F5] flex items-center justify-center text-lg">{cat?.emoji || 'ğŸ“'}</div>
                                                            <div>
                                                                <p className="font-bold text-[#1E3932] line-clamp-1">{t.note || cat?.label || 'ç„¡å‚™è¨»'}</p>
                                                                <p className="text-xs text-[#888]">{t.type === 'transfer' ? 'è½‰å¸³' : acc?.name}</p>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className={`font-bold block ${t.type === 'expense' ? 'text-[#8C4A32]' : t.type === 'income' ? 'text-[#00704A]' : 'text-[#1E3932]'}`}>{t.amount}</span>
                                                            <button onClick={() => delTx(t.id)} className="text-[10px] text-red-300 mt-1">åˆªé™¤</button>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                    {activeTab === 'assets' && <AssetsView />}
                    {activeTab === 'analysis' && <AnalysisView />}
                    {activeTab === 'settings' && <SettingsView />}
                    {activeTab === 'add' && <AddView />}
                    
                    {activeTab !== 'add' && (
                        <div className="fixed bottom-0 w-full bg-white pt-2 pb-6 px-6 flex justify-between items-center shadow-[0_-5px_30px_rgba(0,0,0,0.08)] md:absolute z-40 pb-safe rounded-t-[2rem]">
                            <button onClick={()=>setActiveTab('portal')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${activeTab==='portal'?'text-[#1E3932]':'text-gray-300'}`}><Icons.LayoutGrid strokeWidth={activeTab==='portal'?2.5:2} size={24}/><span className="text-[10px] font-bold">ä¸»é¸å–®</span></button>
                            <button onClick={()=>setActiveTab('home')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${activeTab==='home'?'text-[#1E3932]':'text-gray-300'}`}><Icons.ListOrdered strokeWidth={activeTab==='home'?2.5:2} size={24}/><span className="text-[10px] font-bold">å¸³æœ¬</span></button>
                            <button onClick={()=>{ setType('expense'); setActiveTab('add'); }} className="bg-[#1E3932] text-white p-4 rounded-full -mt-12 shadow-xl border-[6px] border-[#F2F0EB] active:scale-95 transition-transform"><Icons.Plus size={32}/></button>
                            <button onClick={()=>setActiveTab('assets')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${activeTab==='assets'?'text-[#1E3932]':'text-gray-300'}`}><Icons.Wallet strokeWidth={activeTab==='assets'?2.5:2} size={24}/><span className="text-[10px] font-bold">è³‡ç”¢</span></button>
                            <button onClick={()=>setActiveTab('settings')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${activeTab==='settings'?'text-[#1E3932]':'text-gray-300'}`}><Icons.UserCog strokeWidth={activeTab==='settings'?2.5:2} size={24}/><span className="text-[10px] font-bold">è¨­å®š</span></button>
                        </div>
                    )}
                    
                    <SystemDialog isOpen={dialogConfig.isOpen} type={dialogConfig.type} title={dialogConfig.title} message={dialogConfig.message} onConfirm={dialogConfig.onConfirm} onCancel={dialogConfig.onCancel} isDanger={dialogConfig.isDanger} />
                    
                    {isAddingAccountModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-8 animate-in fade-in">
                            <div className="bg-white w-full rounded-3xl p-6 shadow-2xl scale-100 animate-in zoom-in-95">
                                <h3 className="font-bold text-lg mb-4 text-[#1E3932]">æ–°å¢è³‡ç”¢å¸³æˆ¶</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-[#5B665E] mb-1">åç¨±</label><SafeInput autoFocus={true} placeholder="ä¾‹å¦‚ï¼šè–ªè½‰æˆ¶" value={newAccountName} onChange={setNewAccountName} className="w-full bg-[#F5F5F5] p-3 rounded-xl outline-none font-bold text-gray-800"/></div>
                                    <div><label className="block text-xs font-bold text-[#5B665E] mb-1">å¹£åˆ¥</label><div className="flex gap-2">{Object.entries(CURRENCY_CONFIG).map(([c,v])=><button key={c} onClick={()=>setNewAccountCurrency(c)} className={`flex-1 py-2 rounded-lg border font-bold text-xs ${newAccountCurrency===c?'bg-[#1E3932] text-white':'text-gray-500'}`}>{c}</button>)}</div></div>
                                    <div><label className="block text-xs font-bold text-[#5B665E] mb-1">é¡å‹</label><div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{Object.entries(ACCOUNT_TYPE_CONFIG).map(([k,v])=><button key={k} onClick={()=>setNewAccountType(k)} className={`px-4 py-2 rounded-lg border whitespace-nowrap font-bold text-xs ${newAccountType===k?'bg-[#1E3932] text-white':'text-gray-500'}`}>{v.label}</button>)}</div></div>
                                </div>
                                <div className="mt-6 flex gap-3">
                                    <button onClick={()=>setIsAddingAccountModalOpen(false)} className="flex-1 py-3 text-gray-400 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                                    <button onClick={addAcc} className="flex-1 py-3 bg-[#1E3932] text-white rounded-xl font-bold shadow-lg">ç¢ºèª</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {isManualModalOpen && (
                      <div className="fixed inset-0 z-[80] flex items-center justify-center px-4 animate-in fade-in duration-200">
                         <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setIsManualModalOpen(false)}></div>
                         <div className="bg-white w-full max-w-lg h-[70vh] rounded-[2rem] p-0 shadow-2xl relative z-10 flex flex-col overflow-hidden animate-in slide-in-from-bottom-10">
                            <div className="bg-[#1E3932] p-6 text-white shrink-0 relative">
                               <button onClick={() => setIsManualModalOpen(false)} className="absolute top-6 right-6 p-2 bg-white/20 hover:bg-white/30 rounded-full text-white"><Icons.X size={20} /></button>
                               <h3 className="text-2xl font-serif font-bold mb-1">ä½¿ç”¨èªªæ˜</h3>
                               <p className="text-xs opacity-80">æ—¥æ—¥å¸³ Nichinichi v3.5</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-8 space-y-6 bg-[#F9F9F7]">
                               <div><h4 className="font-bold text-[#1E3932] mb-1">é—œæ–¼å­˜æª”</h4><p className="text-sm text-gray-600">æœ¬ç¨‹å¼æ¡ç”¨é›¢ç·šå„²å­˜ (LocalStorage)ã€‚è«‹å‹¿æ¸…é™¤ Safari çš„ç¶²ç«™è³‡æ–™ï¼Œå¦å‰‡ç´€éŒ„å°‡æœƒæ¶ˆå¤±ã€‚å»ºè­°å®šæœŸè‡³ã€Œè¨­å®šã€ä¸‹è¼‰ JSON å‚™ä»½ã€‚</p></div>
                               <div><h4 className="font-bold text-[#1E3932] mb-1">å¦‚ä½•å…¨è¢å¹•ä½¿ç”¨</h4><p className="text-sm text-gray-600">é»æ“Š Safari ä¸‹æ–¹åˆ†äº«æŒ‰éˆ•ï¼Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ï¼Œå³å¯ç²å¾—æœ€ä½³é«”é©—ã€‚</p></div>
                               <div className="text-center pt-4"><button onClick={() => setIsManualModalOpen(false)} className="px-8 py-3 bg-[#1E3932] text-white rounded-full font-bold shadow-lg active:scale-95 transition-transform">é–‹å§‹è¨˜å¸³</button></div>
                            </div>
                         </div>
                      </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
