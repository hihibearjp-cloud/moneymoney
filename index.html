import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Plus, 
  Minus, 
  Wallet, 
  PieChart, 
  Calendar, 
  ChevronLeft, 
  ChevronRight, 
  Coffee, 
  ShoppingBag, 
  Home, 
  Bus, 
  Heart, 
  MoreHorizontal,
  Utensils,
  Shirt,
  Gift,
  BookOpen,
  TrendingUp,
  X,
  CreditCard,
  Landmark,
  Smartphone,
  Trash2,
  BarChart3,
  ArrowRightLeft,
  LayoutGrid,
  ListOrdered,
  Settings,
  Briefcase,
  ArrowRight,
  Edit3,
  Check,
  Globe,
  FileSpreadsheet,
  Download,
  HelpCircle,
  Book,
  UserCog,
  Delete,
  Calculator,
  Save,
  Upload,
  FileJson,
  AlertCircle,
  AlertTriangle,
  FolderOpen,
  RefreshCw,
  Info
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  orderBy, 
  onSnapshot, 
  deleteDoc, 
  doc,
  serverTimestamp,
  updateDoc
} from 'firebase/firestore';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Colors & Theme (Starbucks Vibe) ---
const theme = {
  bg: 'bg-[#F2F0EB]', // æ‹¿éµå¥¶æ³¡ç™½
  card: 'bg-white',
  textMain: 'text-[#1E3932]', // æ˜Ÿå·´å…‹æ·±ç¶ 
  textSub: 'text-[#5B665E]',
  primary: 'bg-[#1E3932]',
  primaryText: 'text-[#1E3932]',
  accent: 'bg-[#C6A87C]', // é‡‘ç„¦ç³–è‰²
  income: 'text-[#00704A]', // ç¶“å…¸ç¶ 
  expense: 'text-[#8C4A32]', // çƒ˜ç„™æ£•
  transfer: 'text-[#1E3932]', // è½‰å¸³æ·±ç¶ 
  border: 'border-[#D4D9D5]',
};

// --- Default Data ---
const DEFAULT_CATEGORIES = [
  { id: 'food', emoji: 'ğŸ™', label: 'é£²é£Ÿ', color: '#8C4A32' },
  { id: 'transport', emoji: 'ğŸšƒ', label: 'äº¤é€š', color: '#4A6C6F' },
  { id: 'shopping', emoji: 'ğŸ›ï¸', label: 'è³¼ç‰©', color: '#C6A87C' },
  { id: 'entertainment', emoji: 'ğŸ¡', label: 'å¨›æ¨‚', color: '#00704A' },
  // Modified: Housing -> Living Bills (Water/Electricity/Gas Icons)
  { id: 'housing', emoji: 'ğŸ’§âš¡ğŸ”¥', label: 'ç”Ÿæ´»ç¹³è²»', color: '#5B4839' },
  // Modified: Clothing -> PX Mart
  { id: 'clothing', emoji: 'ğŸ›’', label: 'å…¨è¯', color: '#A67B5B' },
  { id: 'health', emoji: 'ğŸ’Š', label: 'é†«ç™‚', color: '#9E4244' },
  { id: 'education', emoji: 'ğŸ“š', label: 'å­¸ç¿’', color: '#2C4C3B' },
  { id: 'gift', emoji: 'ğŸ', label: 'ç¦®é‡‘', color: '#D9915B' },
  { id: 'investment', emoji: 'ğŸ’¹', label: 'æŠ•è³‡', color: '#6A7062' },
  { id: 'other', emoji: 'âœ¨', label: 'å…¶ä»–', color: '#808080' },
];

const ACCOUNT_TYPE_CONFIG = {
  cash: { label: 'ç¾é‡‘', icon: Wallet, color: '#C6A87C' },
  bank: { label: 'éŠ€è¡Œ', icon: Landmark, color: '#4A6C6F' },
  card: { label: 'ä¿¡ç”¨å¡', icon: CreditCard, color: '#8C4A32' },
  epay: { label: 'é›»æ”¯', icon: Smartphone, color: '#1E3932' },
  invest: { label: 'æŠ•è³‡', icon: TrendingUp, color: '#556B2F' },
};

const CURRENCY_CONFIG = {
  'TWD': { label: 'å°å¹£', symbol: 'NT$', flag: 'ğŸ‡¹ğŸ‡¼', digits: 0 },
  'USD': { label: 'ç¾å…ƒ', symbol: 'US$', flag: 'ğŸ‡ºğŸ‡¸', digits: 2 },
  'JPY': { label: 'æ—¥åœ“', symbol: 'Â¥', flag: 'ğŸ‡¯ğŸ‡µ', digits: 0 },
};

// --- Helper Functions ---
const formatCurrency = (amount, currencyCode = 'TWD') => {
  const config = CURRENCY_CONFIG[currencyCode] || CURRENCY_CONFIG['TWD'];
  const formattedNumber = new Intl.NumberFormat(currencyCode === 'TWD' || currencyCode === 'JPY' ? 'zh-TW' : 'en-US', {
    minimumFractionDigits: config.digits,
    maximumFractionDigits: config.digits,
  }).format(amount);
  return `${config.flag} ${config.symbol} ${formattedNumber}`;
};

const formatCurrencySimple = (amount, currencyCode = 'TWD') => {
  return formatCurrency(amount, currencyCode); 
};

const formatDate = (dateString) => {
  const date = new Date(dateString);
  const today = new Date();
  if (date.toDateString() === today.toDateString()) return 'ä»Šå¤©';
  return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
};

const getDayOfWeek = (dateString) => {
  const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
  return days[new Date(dateString).getDay()];
};

const getGreeting = () => {
  const hour = new Date().getHours();
  if (hour < 12) return 'æ—©å®‰';
  if (hour < 18) return 'åˆå®‰';
  return 'æ™šå®‰';
};

// --- SafeInput Component (IME Fix for iOS) ---
const SafeInput = ({ value, onChange, placeholder, className, autoFocus, type = 'text', inputRef }) => {
  const [innerValue, setInnerValue] = useState(value);
  const isComposing = useRef(false);

  useEffect(() => {
    setInnerValue(value);
  }, [value]);

  const handleChange = (e) => {
    const val = e.target.value;
    setInnerValue(val);
    if (!isComposing.current) {
      onChange(val);
    }
  };

  const handleCompositionStart = () => {
    isComposing.current = true;
  };

  const handleCompositionEnd = (e) => {
    isComposing.current = false;
    onChange(e.target.value);
  };

  return (
    <input
      ref={inputRef}
      type={type}
      value={innerValue}
      onChange={handleChange}
      onCompositionStart={handleCompositionStart}
      onCompositionEnd={handleCompositionEnd}
      placeholder={placeholder}
      className={className}
      autoFocus={autoFocus}
    />
  );
};

// --- Calculator Component ---
const CalculatorPad = ({ onValueChange, onConfirm }) => {
  const [display, setDisplay] = useState('');

  const handlePress = (key) => {
    if (key === 'C') {
      setDisplay('');
      onValueChange('');
    } else if (key === 'âŒ«') {
      const newVal = display.slice(0, -1);
      setDisplay(newVal);
      if (!isNaN(parseFloat(newVal)) || newVal === '') onValueChange(newVal);
    } else if (key === '=') {
      try {
        const expression = display.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
        // Safe evaluation
        if (/^[0-9+\-*/().\s]*$/.test(expression)) {
           const result = new Function('return ' + expression)().toString();
           const finalResult = result.includes('.') ? parseFloat(result).toFixed(2) : result;
           setDisplay(finalResult);
           onValueChange(finalResult);
        } else {
           setDisplay('Error');
        }
      } catch (e) {
        setDisplay('Error');
      }
    } else if (['+', '-', 'Ã—', 'Ã·'].includes(key)) {
       if (['+', '-', 'Ã—', 'Ã·'].includes(display.slice(-1))) return;
       setDisplay(display + key);
    } else {
       setDisplay(display + key);
       if (!['+', '-', 'Ã—', 'Ã·'].some(op => (display + key).slice(-1) === op)) {
          // pass
       }
    }
  };

  const keys = ['7', '8', '9', 'Ã·', '4', '5', '6', 'Ã—', '1', '2', '3', '-', 'C', '0', '.', '+'];

  return (
    <div className="bg-[#1E3932] p-4 rounded-3xl border-4 border-[#C6A87C] shadow-2xl select-none relative z-50">
      <div className="flex justify-between items-center mb-3 px-1">
         <span className="text-[#C6A87C] font-bold text-xs tracking-widest">CALCULATOR</span>
         <div className="h-8 bg-[#F2F0EB] rounded-lg px-3 flex items-center justify-end w-32 font-mono text-lg text-[#1E3932] overflow-hidden">
            {display || '0'}
         </div>
      </div>
      <div className="grid grid-cols-4 gap-3">
        {keys.map(k => (
          <button key={k} onClick={() => handlePress(k)} className={`h-14 rounded-2xl text-xl font-bold shadow-md transition-all active:scale-90 active:shadow-none ${['Ã·', 'Ã—', '-', '+'].includes(k) ? 'bg-[#C6A87C] text-[#1E3932]' : 'bg-[#F2F0EB] text-[#1E3932]'} ${k === 'C' ? 'bg-[#8C4A32] text-white' : ''}`}>
            {k}
          </button>
        ))}
        <button onClick={() => handlePress('âŒ«')} className="col-span-2 h-14 rounded-2xl bg-[#5B665E] text-white font-bold flex items-center justify-center active:scale-95"><Delete size={24} /></button>
        <button onClick={() => { handlePress('='); setTimeout(onConfirm, 200); }} className="col-span-2 h-14 rounded-2xl bg-white text-[#1E3932] font-bold flex items-center justify-center active:scale-95 border-2 border-[#C6A87C]">å®Œæˆ</button>
      </div>
    </div>
  );
};

// --- System Dialog Component (Replaces Alert/Confirm) ---
const SystemDialog = ({ isOpen, type, title, message, onConfirm, onCancel, isDanger }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center px-6 animate-in fade-in duration-200">
      <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onCancel}></div>
      <div className="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl relative z-10 flex flex-col items-center text-center">
        <div className={`w-14 h-14 rounded-full flex items-center justify-center mb-4 ${isDanger ? 'bg-red-100 text-red-500' : 'bg-[#EBF5F0] text-[#1E3932]'}`}>
           {type === 'confirm' ? <HelpCircle size={32} /> : <Info size={32} />}
        </div>
        <h3 className="text-xl font-bold text-[#1E3932] mb-2">{title}</h3>
        <p className="text-sm text-[#5B665E] mb-6 leading-relaxed">{message}</p>
        
        <div className="flex gap-3 w-full">
           {type === 'confirm' && (
             <button 
               onClick={onCancel}
               className="flex-1 py-3 rounded-xl border-2 border-[#E5E5E5] text-[#888] font-bold active:bg-gray-50 transition-colors"
             >
               å–æ¶ˆ
             </button>
           )}
           <button 
             onClick={onConfirm}
             className={`flex-1 py-3 rounded-xl font-bold text-white shadow-lg active:scale-95 transition-all ${isDanger ? 'bg-red-500 shadow-red-200' : 'bg-[#1E3932] shadow-[#1E3932]/30'}`}
           >
             {type === 'confirm' ? (isDanger ? 'åˆªé™¤' : 'ç¢ºå®š') : 'çŸ¥é“äº†'}
           </button>
        </div>
      </div>
    </div>
  );
};


// --- Hierarchical Account Selector ---
const AccountSelector = ({ accounts, selectedId, onSelect, label }) => {
  const [viewState, setViewState] = useState('category'); // 'category' | 'list'
  const [selectedCategory, setSelectedCategory] = useState(null);

  // Reset internal state if external selectedId changes to null (reset)
  useEffect(() => {
    if (!selectedId) {
      setViewState('category');
      setSelectedCategory(null);
    }
  }, [selectedId]);

  const selectedAccount = accounts.find(a => a.id === selectedId);

  // If account is selected, show selected state
  if (selectedAccount) {
    const config = ACCOUNT_TYPE_CONFIG[selectedAccount.type];
    const currency = CURRENCY_CONFIG[selectedAccount.currency || 'TWD'];
    return (
      <div className="mb-6">
         <label className="block text-sm font-bold text-[#5B665E] mb-2 pl-1 tracking-widest text-center">- {label} -</label>
         <button 
           onClick={() => onSelect('')} // Deselect
           className="w-full bg-[#1E3932] p-4 rounded-2xl shadow-md flex items-center justify-between group active:scale-95 transition-all"
         >
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white">
                 <Check size={20} />
              </div>
              <div className="text-left text-white">
                 <p className="text-sm font-bold">{selectedAccount.name}</p>
                 <p className="text-xs opacity-70 flex items-center gap-1">
                   <span>{currency.flag}</span> {config.label}
                 </p>
              </div>
            </div>
            <div className="bg-white/20 px-3 py-1 rounded-full text-[10px] text-white font-bold group-hover:bg-white group-hover:text-[#1E3932] transition-colors">
               æ›´æ›
            </div>
         </button>
      </div>
    );
  }

  // Step 2: Account List
  if (viewState === 'list' && selectedCategory) {
    const config = ACCOUNT_TYPE_CONFIG[selectedCategory];
    const filteredAccounts = accounts.filter(a => a.type === selectedCategory);
    
    return (
      <div className="mb-6 animate-in slide-in-from-right-4 fade-in duration-200">
         <div className="flex items-center justify-between mb-3 px-1">
            <button onClick={() => setViewState('category')} className="text-xs font-bold text-[#888] flex items-center gap-1 hover:text-[#1E3932]">
               <ChevronLeft size={14} /> è¿”å›é¡åˆ¥
            </button>
            <span className="text-sm font-bold text-[#1E3932] tracking-widest flex items-center gap-2">
               <config.icon size={16}/> {config.label}
            </span>
            <div className="w-10"></div> {/* Spacer */}
         </div>
         
         <div className="grid grid-cols-2 gap-3">
            {filteredAccounts.length > 0 ? (
               filteredAccounts.map(acc => {
                  const accCur = CURRENCY_CONFIG[acc.currency || 'TWD'];
                  return (
                    <button 
                      key={acc.id} 
                      onClick={() => onSelect(acc.id)}
                      className="bg-white p-3 rounded-xl border border-[#D4D9D5] shadow-sm flex flex-col items-start gap-1 hover:border-[#1E3932] hover:bg-[#F2F0EB] transition-all active:scale-95"
                    >
                       <span className="text-xl mb-1">{accCur.flag}</span>
                       <span className="text-sm font-bold text-[#1E3932] line-clamp-1">{acc.name}</span>
                       <span className="text-[10px] text-[#888]">{accCur.label}</span>
                    </button>
                  )
               })
            ) : (
               <div className="col-span-2 text-center py-6 text-[#888] text-xs bg-white rounded-xl border border-dashed border-[#D4D9D5]">
                  æ­¤é¡åˆ¥å°šç„¡å¸³æˆ¶
               </div>
            )}
         </div>
      </div>
    );
  }

  // Step 1: Category Selection
  return (
    <div className="mb-6">
       <label className="block text-sm font-bold text-[#5B665E] mb-3 pl-1 tracking-widest text-center">- {label} -</label>
       <div className="grid grid-cols-3 gap-3">
          {Object.entries(ACCOUNT_TYPE_CONFIG).map(([key, config]) => (
             <button 
               key={key}
               onClick={() => { setSelectedCategory(key); setViewState('list'); }}
               className="bg-white p-3 rounded-xl border border-[#D4D9D5] shadow-sm flex flex-col items-center justify-center gap-2 hover:border-[#1E3932] hover:text-[#1E3932] text-[#5B665E] transition-all active:scale-95 h-20"
             >
                <config.icon size={20} />
                <span className="text-xs font-bold">{config.label}</span>
             </button>
          ))}
       </div>
    </div>
  );
};


// --- Main Component ---
export default function App() {
  const [user, setUser] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [accounts, setAccounts] = useState([]); 
  const [categories, setCategories] = useState([]);
  const [activeTab, setActiveTab] = useState('portal');
  
  // Navigation State for Assets
  const [selectedAssetCategory, setSelectedAssetCategory] = useState(null); 

  const [isLoading, setIsLoading] = useState(true);

  // Form State
  const [amount, setAmount] = useState('');
  const [note, setNote] = useState('');
  const [selectedCategoryId, setSelectedCategoryId] = useState('');
  const [selectedAccountId, setSelectedAccountId] = useState(''); 
  const [toAccountId, setToAccountId] = useState(''); 
  const [type, setType] = useState('expense');
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showCalculator, setShowCalculator] = useState(false); 

  const amountInputRef = useRef(null);
  const fileInputRef = useRef(null);

  // Dialog State
  const [dialogConfig, setDialogConfig] = useState({ isOpen: false, type: 'alert', title: '', message: '', onConfirm: () => {}, isDanger: false });

  // Analysis State
  const [analysisPeriod, setAnalysisPeriod] = useState('month'); 

  // Modal States
  const [isAddingAccountModalOpen, setIsAddingAccountModalOpen] = useState(false);
  const [isManualModalOpen, setIsManualModalOpen] = useState(false); 
  const [newAccountName, setNewAccountName] = useState('');
  const [newAccountType, setNewAccountType] = useState('bank');
  const [newAccountCurrency, setNewAccountCurrency] = useState('TWD'); 

  // Category Management State
  const [isManagingCategories, setIsManagingCategories] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [newCategoryEmoji, setNewCategoryEmoji] = useState('ğŸŒŸ');
  const [newCategoryColor, setNewCategoryColor] = useState('#808080');

  // --- Helpers for Dialog ---
  const showAlert = (title, message) => {
    setDialogConfig({ isOpen: true, type: 'alert', title, message, onConfirm: () => setDialogConfig(prev => ({...prev, isOpen: false})) });
  };

  const showConfirm = (title, message, onConfirm, isDanger = false) => {
    setDialogConfig({ 
      isOpen: true, 
      type: 'confirm', 
      title, 
      message, 
      isDanger,
      onConfirm: () => { 
        onConfirm(); 
        setDialogConfig(prev => ({...prev, isOpen: false})); 
      },
      onCancel: () => setDialogConfig(prev => ({...prev, isOpen: false}))
    });
  };

  // --- Auth & Data Fetching ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (!currentUser) setIsLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Fetch Transactions
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      data.sort((a, b) => {
        if (a.date !== b.date) return b.date.localeCompare(a.date);
        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
      });
      setTransactions(data);
    });
    return () => unsubscribe();
  }, [user]);

  // Fetch Accounts
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'accounts');
    const unsubscribe = onSnapshot(q, async (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (data.length === 0 && !snapshot.metadata.fromCache) {
        const defaultAccounts = [
          { name: 'ç¾é‡‘éŒ¢åŒ…', type: 'cash', currency: 'TWD', isDefault: true },
          { name: 'è–ªè³‡å¸³æˆ¶', type: 'bank', currency: 'TWD', isDefault: true },
          { name: 'ä¸»è¦ä¿¡ç”¨å¡', type: 'card', currency: 'TWD', isDefault: true },
          { name: 'ç¾è‚¡æŠ•è³‡', type: 'invest', currency: 'USD', isDefault: true },
        ];
        for (const acc of defaultAccounts) {
          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'accounts'), { ...acc, createdAt: serverTimestamp() });
        }
      } else {
        const typePriority = { cash: 1, bank: 2, epay: 3, card: 4, invest: 5 };
        data.sort((a, b) => {
           const typeDiff = (typePriority[a.type] || 99) - (typePriority[b.type] || 99);
           if (typeDiff !== 0) return typeDiff;
           return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
        });
        setAccounts(data);
        if (data.length > 0 && !selectedAccountId) setSelectedAccountId(data[0].id);
        setIsLoading(false);
      }
    });
    return () => unsubscribe();
  }, [user]);

  // Fetch Categories
  useEffect(() => {
    if (!user) return;
    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'categories');
    const unsubscribe = onSnapshot(q, async (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (data.length === 0 && !snapshot.metadata.fromCache) {
        for (const cat of DEFAULT_CATEGORIES) {
           await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), { ...cat, createdAt: serverTimestamp() });
        }
      } else {
        data.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
        setCategories(data);
        if (data.length > 0 && !selectedCategoryId) setSelectedCategoryId(data[0].id);
      }
    });
    return () => unsubscribe();
  }, [user]);

  // --- Export / Import / Clear Logic ---
  const downloadFile = (content, fileName, type) => {
    const BOM = '\uFEFF';
    const blob = new Blob([type === 'csv' ? BOM + content : content], { type: type === 'csv' ? 'text/csv;charset=utf-8;' : 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleExportRawData = () => {
    if (transactions.length === 0) { showAlert('æç¤º', "æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™"); return; }
    let csv = "æ—¥æœŸ,é¡å‹,åˆ†é¡,é …ç›®/å‚™è¨»,é‡‘é¡,å¹£åˆ¥,å¸³æˆ¶,è½‰å…¥å¸³æˆ¶(è‹¥ç‚ºè½‰å¸³)\n";
    transactions.forEach(t => {
      const acc = accounts.find(a => a.id === t.accountId);
      const toAcc = t.toAccountId ? accounts.find(a => a.id === t.toAccountId) : null;
      const cat = categories.find(c => c.id === t.category) || DEFAULT_CATEGORIES.find(c => c.id === t.category);
      const currency = acc ? (acc.currency || 'TWD') : 'TWD';
      let typeLabel = t.type === 'expense' ? 'æ”¯å‡º' : t.type === 'income' ? 'æ”¶å…¥' : 'è½‰å¸³';
      let catLabel = t.type === 'transfer' ? 'è½‰å¸³' : (cat ? cat.label : 'å…¶ä»–');
      let note = (t.note || '').replace(/,/g, ' '); 
      let amount = t.amount;
      csv += `${t.date},${typeLabel},${catLabel},${note},${amount},${currency},${acc ? acc.name : 'å·²åˆªé™¤'},${toAcc ? toAcc.name : ''}\n`;
    });
    downloadFile(csv, `æ—¥æ—¥å¸³_åŸå§‹æ˜ç´°_${new Date().toISOString().slice(0,10)}.csv`, 'csv');
  };

  const handleExportMatrix = () => {
    if (transactions.length === 0) { showAlert('æç¤º', "æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™"); return; }
    const months = [...new Set(transactions.map(t => t.date.substring(0, 7)))].sort().reverse();
    let headerRow = "æœˆä»½";
    accounts.forEach(acc => {
       const curSymbol = CURRENCY_CONFIG[acc.currency || 'TWD'].flag;
       headerRow += `,${curSymbol} ${acc.name} (${acc.currency || 'TWD'})`;
    });
    headerRow += ",å‚™è¨»\n";
    let csv = headerRow;
    months.forEach(month => {
      let row = `${month}`;
      accounts.forEach(acc => {
        let netFlow = 0;
        const monthlyTxs = transactions.filter(t => t.date.startsWith(month));
        monthlyTxs.forEach(t => {
          if (t.accountId === acc.id) {
             if (t.type === 'income') netFlow += t.amount;
             else if (t.type === 'expense') netFlow -= t.amount;
             else if (t.type === 'transfer') netFlow -= t.amount; 
          }
          if (t.type === 'transfer' && t.toAccountId === acc.id) {
             netFlow += t.amount; 
          }
        });
        row += `,${netFlow}`;
      });
      row += `,æœ¬æœˆå¸³æˆ¶è®Šå‹•çŸ©é™£\n`;
      csv += row;
    });
    downloadFile(csv, `æ—¥æ—¥å¸³_è³‡é‡‘çŸ©é™£_${new Date().toISOString().slice(0,10)}.csv`, 'csv');
  };

  const handleBackupJSON = () => {
    const backupData = {
      version: "2.13",
      exportDate: new Date().toISOString(),
      data: {
        accounts,
        categories,
        transactions
      }
    };
    downloadFile(JSON.stringify(backupData, null, 2), `nichinichi_backup_${new Date().toISOString().slice(0,10)}.json`, 'json');
  };

  const handleRestoreJSON = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    showConfirm('é‚„åŸå‚™ä»½', 'âš ï¸ é€™å°‡æœƒæŠŠå‚™ä»½æª”ä¸­çš„è³‡æ–™ã€Œæ–°å¢ã€åˆ°ç›®å‰çš„å¸³æœ¬ä¸­ï¼Œå¯èƒ½æœƒé€ æˆè³‡æ–™é‡è¤‡ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ', () => {
       const reader = new FileReader();
       reader.onload = async (e) => {
         try {
           const backup = JSON.parse(e.target.result);
           if (!backup.data || !backup.data.accounts) { showAlert('éŒ¯èª¤', "ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼"); return; }
           const accountMap = {};
           const categoryMap = {};
           for (const acc of backup.data.accounts) {
             const { id, ...accData } = acc;
             const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'accounts'), { ...accData, createdAt: serverTimestamp() });
             accountMap[id] = docRef.id;
           }
           if (backup.data.categories) {
             for (const cat of backup.data.categories) {
               const { id, ...catData } = cat;
               const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), { ...catData, createdAt: serverTimestamp() });
               categoryMap[id] = docRef.id;
             }
           }
           for (const tx of backup.data.transactions) {
             const { id, accountId, toAccountId, category, ...txData } = tx;
             const newAccountId = accountMap[accountId] || accountId;
             const newToAccountId = toAccountId ? (accountMap[toAccountId] || toAccountId) : null;
             const newCategory = categoryMap[category] || category;
             const newTx = { ...txData, accountId: newAccountId, category: newCategory, createdAt: serverTimestamp() };
             if (newToAccountId) newTx.toAccountId = newToAccountId;
             await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), newTx);
           }
           showAlert('é‚„åŸæˆåŠŸ', `åŒ¯å…¥äº† ${backup.data.transactions.length} ç­†äº¤æ˜“ã€${backup.data.accounts.length} å€‹å¸³æˆ¶ã€‚`);
         } catch (error) { console.error(error); showAlert('éŒ¯èª¤', "é‚„åŸå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆã€‚"); }
         event.target.value = '';
       };
       reader.readAsText(file);
    }, true);
  };

  const handleClearAllData = async () => {
    showConfirm('å±éšªæ“ä½œ', 'æ­¤æ“ä½œå°‡ã€Œæ°¸ä¹…åˆªé™¤ã€æ‰€æœ‰è¨˜å¸³ç´€éŒ„ã€å¸³æˆ¶èˆ‡è¨­å®šï¼Œç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ', async () => {
        setIsLoading(true);
        try {
          const txPromises = transactions.map(t => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', t.id)));
          const accPromises = accounts.map(a => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'accounts', a.id)));
          const catPromises = categories.map(c => deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'categories', c.id)));
          await Promise.all([...txPromises, ...accPromises, ...catPromises]);
          showAlert('å®Œæˆ', "æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¸…é™¤ï¼Œç³»çµ±å·²é‡ç½®ã€‚");
          setSelectedAccountId('');
          setToAccountId('');
        } catch (error) { console.error("Error clearing data:", error); showAlert('éŒ¯èª¤', "æ¸…é™¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚"); } finally { setIsLoading(false); }
    }, true);
  };

  // --- Logic Handlers ---
  const handleAddTransaction = async () => {
    if (!amount || isNaN(amount) || Number(amount) <= 0) return;
    if (!user) return;
    if (type === 'transfer' && (!selectedAccountId || !toAccountId || selectedAccountId === toAccountId)) return;
    if (type !== 'transfer' && (!selectedAccountId || !selectedCategoryId)) return;

    setIsSubmitting(true);
    try {
      const docData = { amount: Number(amount), type, note, date, createdAt: serverTimestamp(), accountId: selectedAccountId };
      if (type === 'transfer') { docData.toAccountId = toAccountId; docData.category = 'transfer'; } else { docData.category = selectedCategoryId; }
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), docData);
      setAmount(''); setNote(''); setShowCalculator(false);
      if (type !== 'transfer') { if(categories.length > 0) setSelectedCategoryId(categories[0].id); }
      setActiveTab('home'); 
    } catch (error) { console.error(error); } finally { setIsSubmitting(false); }
  };

  const handleDeleteTransaction = async (id) => {
    if (!user) return;
    showConfirm('åˆªé™¤ç´€éŒ„', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†äº¤æ˜“å—ï¼Ÿ', async () => {
       try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id)); } catch (error) { console.error(error); }
    }, true);
  };

  const handleAddAccount = async () => {
    if (!newAccountName || !user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'accounts'), {
        name: newAccountName,
        type: newAccountType,
        currency: newAccountCurrency, 
        createdAt: serverTimestamp()
      });
      setIsAddingAccountModalOpen(false);
      setNewAccountName('');
      setNewAccountCurrency('TWD');
      setSelectedAssetCategory(newAccountType);
    } catch (error) { console.error(error); }
  };

  const handleDeleteAccount = async (id) => {
    if (!user) return;
    showConfirm('åˆªé™¤å¸³æˆ¶', 'ç¢ºå®šè¦åˆªé™¤é€™å€‹å¸³æˆ¶å—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„äº¤æ˜“ç´€éŒ„å¯èƒ½æœƒé¡¯ç¤ºç•°å¸¸ã€‚', async () => {
       try {
         await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'accounts', id));
         if (selectedAccountId === id && accounts.length > 1) setSelectedAccountId(accounts.find(a => a.id !== id)?.id || '');
       } catch (error) { console.error(error); }
    }, true);
  };

  const handleAddCategory = async () => {
    if (!newCategoryName || !user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), {
        label: newCategoryName,
        emoji: newCategoryEmoji,
        color: newCategoryColor,
        createdAt: serverTimestamp()
      });
      setNewCategoryName(''); setIsManagingCategories(false);
    } catch (error) { console.error(error); }
  };

  const handleDeleteCategory = async (id) => {
    if (!user) return;
    showConfirm('åˆªé™¤åˆ†é¡', 'ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡å—ï¼Ÿ', async () => {
       try { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'categories', id)); } catch (error) { console.error(error); }
    }, true);
  };

  // --- Computed Stats ---
  const currentMonthStats = useMemo(() => {
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    let income = 0;
    let expense = 0;
    transactions.forEach(t => {
      const tDate = new Date(t.date);
      const acc = accounts.find(a => a.id === t.accountId);
      const currency = acc ? (acc.currency || 'TWD') : 'TWD';
      if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) {
        if (currency === 'TWD') {
          if (t.type === 'income') income += t.amount;
          else if (t.type === 'expense') expense += t.amount;
        }
      }
    });
    return { income, expense, balance: income - expense };
  }, [transactions, accounts]);

  const accountBalances = useMemo(() => {
    const balances = {};
    accounts.forEach(acc => balances[acc.id] = 0);
    const totalsByCurrency = { 'TWD': { assets: 0, liabilities: 0, net: 0 }, 'USD': { assets: 0, liabilities: 0, net: 0 }, 'JPY': { assets: 0, liabilities: 0, net: 0 } };
    transactions.forEach(t => {
      if (balances[t.accountId] !== undefined) {
        if (t.type === 'income') balances[t.accountId] += t.amount;
        else if (t.type === 'expense') balances[t.accountId] -= t.amount;
        else if (t.type === 'transfer') balances[t.accountId] -= t.amount;
      }
      if (t.type === 'transfer' && t.toAccountId && balances[t.toAccountId] !== undefined) balances[t.toAccountId] += t.amount;
    });
    accounts.forEach(acc => {
      const bal = balances[acc.id] || 0;
      const cur = acc.currency || 'TWD';
      if (acc.type === 'card' && bal < 0) totalsByCurrency[cur].liabilities += Math.abs(bal);
      else if (bal < 0) totalsByCurrency[cur].liabilities += Math.abs(bal);
      else totalsByCurrency[cur].assets += bal;
    });
    Object.keys(totalsByCurrency).forEach(k => { totalsByCurrency[k].net = totalsByCurrency[k].assets - totalsByCurrency[k].liabilities; });
    return { balances, totalsByCurrency };
  }, [transactions, accounts]);

  const groupedTransactions = useMemo(() => {
    const groups = {};
    transactions.forEach(t => {
      if (!groups[t.date]) groups[t.date] = [];
      groups[t.date].push(t);
    });
    return Object.entries(groups).sort((a, b) => new Date(b[0]) - new Date(a[0]));
  }, [transactions]);

  const analysisData = useMemo(() => {
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const today = new Date();
    const dayOfWeek = today.getDay();
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - dayOfWeek);
    startOfWeek.setHours(0,0,0,0);

    let filtered = [];
    if (analysisPeriod === 'month') {
      filtered = transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
    } else {
      filtered = transactions.filter(t => { const d = new Date(t.date); return d >= startOfWeek; });
    }

    const byCategory = {};
    let totalExp = 0;
    let totalInc = 0;

    filtered.forEach(t => {
      if (t.type === 'expense') {
        totalExp += t.amount;
        const cat = categories.find(c => c.id === t.category) || DEFAULT_CATEGORIES.find(c => c.id === t.category);
        const catName = cat ? cat.label : 'å…¶ä»–';
        if (!byCategory[catName]) byCategory[catName] = 0;
        byCategory[catName] += t.amount;
      } else if (t.type === 'income') {
        totalInc += t.amount;
      }
    });

    const sortedCategory = Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([key, val]) => ({ key, val, percent: totalExp > 0 ? (val / totalExp) * 100 : 0 }));
    return { filtered, totalExp, totalInc, sortedCategory };
  }, [transactions, analysisPeriod, accounts, categories]);

  // --- Components ---

  const LoadingScreen = () => (
    <div className={`h-screen w-full flex flex-col items-center justify-center ${theme.bg}`}>
      <div className="animate-spin rounded-full h-14 w-14 border-4 border-[#1E3932] border-t-transparent"></div>
    </div>
  );

  const Header = ({ title, subtitle, showGreeting, showBackToPortal, onBack }) => (
    <div className={`pt-14 pb-4 px-6 ${theme.bg} sticky top-0 z-10 w-full`}>
      <div className="flex flex-col">
        {showGreeting && (<div className="flex justify-between items-start"><p className="text-sm font-bold text-[#888] tracking-widest mb-1">{getGreeting()}ï¼Œæ—¥æ—¥å¥½æ—¥</p></div>)}
        <div className="flex justify-between items-end mt-1">
          <div className="flex items-center gap-3">
            {showBackToPortal && (
              <button 
                onClick={onBack || (() => setActiveTab('portal'))} 
                className="p-1.5 -ml-1.5 rounded-full hover:bg-gray-200 transition-colors"
              >
                <ChevronLeft size={28} className={theme.textMain} />
              </button>
            )}
            <h1 className={`text-3xl font-serif font-extrabold tracking-wider ${theme.textMain}`}>{title}</h1>
          </div>
          {subtitle && (<div className="text-sm font-bold text-[#1E3932] bg-white px-3 py-1 rounded-full shadow-sm border border-[#D4D9D5]">{subtitle}</div>)}
        </div>
      </div>
    </div>
  );

  const SettingsView = () => (
    <>
      <Header title="è¨­å®š" subtitle="Settings" />
      <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 no-scrollbar">
        <div className="space-y-6">
          <button onClick={() => setIsManualModalOpen(true)} className="w-full flex items-center justify-between p-6 bg-[#1E3932] text-white rounded-3xl shadow-lg hover:bg-[#152924] active:scale-95 transition-all group">
              <div className="flex items-center gap-4"><div className="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center"><Book size={24} /></div><div className="text-left"><p className="text-lg font-bold">ä½¿ç”¨èªªæ˜æ›¸</p><p className="text-xs opacity-80">æ–°æ‰‹å…¥é–€èˆ‡åŠŸèƒ½ä»‹ç´¹</p></div></div>
              <ChevronRight size={24} className="opacity-60 group-hover:opacity-100 transition-opacity"/>
          </button>

          {/* Backup & Restore Section */}
          <div className="bg-white p-5 rounded-3xl border border-[#E5E5E5] shadow-sm">
              <h4 className="font-bold text-[#5B665E] mb-4 text-base flex items-center gap-2"><Save size={20} /> è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h4>
              <div className="grid gap-4">
                <button onClick={handleBackupJSON} className="flex items-center justify-between p-4 bg-[#F2F0EB] rounded-2xl shadow-sm border border-[#E5E5E5] hover:border-[#1E3932] active:scale-95 transition-all group">
                  <div className="text-left"><p className="text-sm font-bold text-[#1E3932] flex items-center gap-2"><FileJson size={16}/> ä¸‹è¼‰å‚™ä»½ (JSON)</p><p className="text-[10px] text-[#888] mt-0.5">ä¿å­˜æ‰€æœ‰å¸³æˆ¶èˆ‡äº¤æ˜“ç´€éŒ„</p></div>
                  <Download size={20} className="text-[#888] group-hover:text-[#1E3932]" />
                </button>
                
                <div className="relative">
                   <input type="file" accept=".json" onChange={handleRestoreJSON} ref={fileInputRef} className="hidden" />
                   <button onClick={() => fileInputRef.current.click()} className="w-full flex items-center justify-between p-4 bg-[#F2F0EB] rounded-2xl shadow-sm border border-[#E5E5E5] hover:border-[#1E3932] active:scale-95 transition-all group">
                      <div className="text-left"><p className="text-sm font-bold text-[#1E3932] flex items-center gap-2"><Upload size={16}/> é‚„åŸå‚™ä»½ (JSON)</p><p className="text-[10px] text-[#888] mt-0.5">å¾æª”æ¡ˆå¾©åŸæ‚¨çš„è³‡æ–™</p></div>
                      <Upload size={20} className="text-[#888] group-hover:text-[#1E3932]" />
                   </button>
                </div>
              </div>
              <div className="mt-4 flex items-start gap-2 p-3 bg-blue-50 rounded-xl">
                 <AlertCircle size={16} className="text-blue-400 shrink-0 mt-0.5" />
                 <p className="text-[10px] text-blue-400 leading-tight">æ³¨æ„ï¼šé‚„åŸåŠŸèƒ½æœƒå°‡å‚™ä»½æª”ä¸­çš„è³‡æ–™ã€Œæ–°å¢ã€åˆ°ç›®å‰çš„å¸³æœ¬ä¸­ã€‚</p>
              </div>
          </div>

          <div className="bg-[#F9F9F7] p-5 rounded-3xl border border-[#E5E5E5] shadow-sm">
              <h4 className="font-bold text-[#5B665E] mb-4 text-base flex items-center gap-2"><FileSpreadsheet size={20} /> Excel å ±è¡¨åŒ¯å‡º</h4>
              <div className="grid gap-4">
                <button onClick={handleExportMatrix} className="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-[#E5E5E5] hover:border-[#1E3932] active:bg-[#F2F0EB] transition-all group">
                  <div className="text-left"><p className="text-sm font-bold text-[#1E3932]">åŒ¯å‡ºæœˆåº¦è³‡é‡‘çŸ©é™£</p><p className="text-[10px] text-[#888] mt-0.5">æŸ¥çœ‹æ¯æœˆå„å¸³æˆ¶é¤˜é¡è®Šå‹•</p></div>
                  <Download size={20} className="text-[#888] group-hover:text-[#1E3932]" />
                </button>
                <button onClick={handleExportRawData} className="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-[#E5E5E5] hover:border-[#1E3932] active:bg-[#F2F0EB] transition-all group">
                  <div className="text-left"><p className="text-sm font-bold text-[#1E3932]">åŒ¯å‡ºåŸå§‹æ˜ç´°</p><p className="text-[10px] text-[#888] mt-0.5">å®Œæ•´æµæ°´å¸³ (å«å‚™è¨»ã€åˆ†é¡)</p></div>
                  <Download size={20} className="text-[#888] group-hover:text-[#1E3932]" />
                </button>
              </div>
          </div>

          {/* DANGER ZONE - Clear Data */}
          <div className="bg-red-50 p-5 rounded-3xl border border-red-100 shadow-sm mt-8">
              <h4 className="font-bold text-red-700 mb-4 text-base flex items-center gap-2"><AlertTriangle size={20} /> å±éšªå€åŸŸ</h4>
              <button 
                onClick={handleClearAllData} 
                className="w-full flex items-center justify-center gap-2 p-4 bg-white border border-red-200 text-red-500 rounded-2xl shadow-sm hover:bg-red-500 hover:text-white hover:border-red-500 transition-all active:scale-95"
              >
                <Trash2 size={18} />
                <span className="font-bold text-sm">æ¸…é™¤æ‰€æœ‰è³‡æ–™ (é‡ç½®)</span>
              </button>
              <p className="text-[10px] text-red-400 mt-2 text-center">æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰è¨˜å¸³ã€å¸³æˆ¶èˆ‡åˆ†é¡è¨­å®šï¼Œç„¡æ³•å¾©åŸã€‚</p>
          </div>

          <div className="text-center py-4"><p className="text-[10px] text-[#AAA]">æ—¥æ—¥å¸³ Nichinichi v2.13</p></div>
        </div>
      </div>
    </>
  );

  const UserManualModal = () => {
    if (!isManualModalOpen) return null;
    return (
      <div className="fixed inset-0 z-[80] flex items-center justify-center px-4 animate-in fade-in duration-200">
         <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setIsManualModalOpen(false)}></div>
         <div className="bg-white w-full max-w-lg h-[80vh] rounded-[2rem] p-0 shadow-2xl relative z-10 flex flex-col overflow-hidden">
            <div className="bg-[#1E3932] p-6 text-white shrink-0 relative">
               <button onClick={() => setIsManualModalOpen(false)} className="absolute top-6 right-6 p-2 bg-white/20 hover:bg-white/30 rounded-full text-white"><X size={20} /></button>
               <h3 className="text-2xl font-serif font-bold mb-1">ä½¿ç”¨èªªæ˜æ›¸</h3>
               <p className="text-xs opacity-80">æ—¥æ—¥å¸³ Nichinichi 2.13</p>
            </div>
            <div className="flex-1 overflow-y-auto p-6 space-y-8 bg-[#F9F9F7]">
               <section><h4 className="flex items-center gap-2 font-bold text-[#1E3932] mb-3 text-lg"><Save size={20} /> å‚™ä»½èˆ‡é‚„åŸ</h4>
                  <div className="bg-white p-4 rounded-2xl shadow-sm border border-[#E5E5E5] space-y-2 text-sm text-[#555]">
                     <p>ç‚ºäº†é˜²æ­¢è³‡æ–™éºå¤±ï¼Œè«‹å®šæœŸå‚™ä»½ï¼š</p>
                     <ul className="list-disc pl-5 space-y-1">
                        <li><b>ä¸‹è¼‰å‚™ä»½</b>ï¼šå°‡æ‰€æœ‰è³‡æ–™å­˜æˆ JSON æª”æ¡ˆã€‚</li>
                        <li><b>é‚„åŸå‚™ä»½</b>ï¼šä¸Šå‚³ JSON æª”ï¼Œç³»çµ±æœƒè‡ªå‹•å»ºç«‹å°æ‡‰çš„å¸³æˆ¶èˆ‡åˆ†é¡ï¼Œä¸¦åŒ¯å…¥äº¤æ˜“ç´€éŒ„ã€‚</li>
                     </ul>
                  </div>
               </section>
               <section><h4 className="flex items-center gap-2 font-bold text-[#1E3932] mb-3 text-lg"><LayoutGrid size={20} /> éšå±¤å¼å¸³æˆ¶é¸æ“‡</h4>
                  <div className="bg-white p-4 rounded-2xl shadow-sm border border-[#E5E5E5] space-y-2 text-sm text-[#555]">
                     <p>ç„¡è«–åœ¨è¨˜å¸³æˆ–è½‰å¸³ï¼Œç¾åœ¨é¸æ“‡å¸³æˆ¶æ›´æ¸…æ™°äº†ï¼š</p>
                     <ul className="list-disc pl-5 space-y-1">
                        <li>å…ˆé»é¸<b>å¸³æˆ¶é¡åˆ¥</b>ï¼ˆå¦‚ï¼šç¾é‡‘ã€éŠ€è¡Œã€ä¿¡ç”¨å¡ï¼‰ã€‚</li>
                        <li>å†é¸æ“‡è©²é¡åˆ¥ä¸‹çš„<b>å…·é«”å¸³æˆ¶</b>ã€‚</li>
                        <li>é¸éŒ¯é¡åˆ¥å¯é»æ“Šå·¦ä¸Šè§’ã€Œè¿”å›é¡åˆ¥ã€ã€‚</li>
                     </ul>
                  </div>
               </section>
               <section><h4 className="flex items-center gap-2 font-bold text-[#1E3932] mb-3 text-lg"><Edit3 size={20} /> è¨˜å¸³æŠ€å·§</h4>
                  <div className="bg-white p-4 rounded-2xl shadow-sm border border-[#E5E5E5] space-y-3 text-sm text-[#555]">
                     <div><p className="font-bold text-[#8C4A32] mb-1">å°è¨ˆç®—æ©Ÿ</p><p>åœ¨é‡‘é¡è¼¸å…¥æ¡†çš„ä¸‹æ–¹ï¼Œé»æ“Š<b>é•·æ¢çš„è¨ˆç®—æ©ŸæŒ‰éˆ•</b>å³å¯é–‹å•Ÿï¼Œè¨ˆç®—çµæœæœƒè‡ªå‹•å¡«å…¥ã€‚</p></div><hr className="border-dashed border-[#E0E0E0]"/>
                     <div><p className="font-bold text-[#8C4A32] mb-1">3D ç«‹é«”æŒ‰éˆ•</p><p>æŒ‰éˆ•å…·æœ‰çœŸå¯¦çš„æŒ‰å£“å›é¥‹ï¼Œè®“è¨˜å¸³æ›´æœ‰æ‰‹æ„Ÿã€‚</p></div><hr className="border-dashed border-[#E0E0E0]"/>
                     <div><p className="font-bold text-[#1E3932] mb-1">åˆ†é¡ç®¡ç†</p><p>é»æ“Šåˆ†é¡å€å³ä¸Šè§’çš„<b>ã€Œâš™ï¸ ç®¡ç†ã€</b>ï¼Œå¯è‡ªè¨‚å°ˆå±¬çš„ Emoji åˆ†é¡ã€‚</p></div>
                  </div>
               </section>
               <div className="text-center pb-6"><button onClick={() => setIsManualModalOpen(false)} className="px-8 py-3 bg-[#1E3932] text-white rounded-full font-bold shadow-lg active:scale-95 transition-transform">é–‹å§‹ä½¿ç”¨</button></div>
            </div>
         </div>
      </div>
    );
  };

  const AddAccountModal = () => {
    if (!isAddingAccountModalOpen) return null;
    return (
      <div className="fixed inset-0 z-[60] flex items-center justify-center px-4 animate-in fade-in duration-200">
        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setIsAddingAccountModalOpen(false)}></div>
        <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl transform scale-100 transition-all relative z-10">
          <button onClick={() => setIsAddingAccountModalOpen(false)} className="absolute top-4 right-4 p-2 text-[#888] hover:bg-gray-100 rounded-full"><X size={20} /></button>
          <div className="flex flex-col items-center mb-6"><div className="w-12 h-12 rounded-2xl bg-[#1E3932] flex items-center justify-center text-white mb-3 shadow-lg"><Plus size={24} strokeWidth={3} /></div><h3 className="text-xl font-bold text-[#1E3932]">æ–°å¢è³‡ç”¢å¸³æˆ¶</h3></div>
          <div className="space-y-4">
            <div><label className="block text-xs font-bold text-[#5B665E] mb-2 pl-1">å¸³æˆ¶åç¨±</label><SafeInput autoFocus={true} placeholder="ä¾‹å¦‚ï¼šFirstrade ç¾è‚¡" value={newAccountName} onChange={setNewAccountName} className="w-full bg-[#F5F5F5] p-4 rounded-xl outline-none text-gray-800 font-bold border-2 border-transparent focus:border-[#1E3932] focus:bg-white transition-colors" /></div>
             <div><label className="block text-xs font-bold text-[#5B665E] mb-2 pl-1">é¸æ“‡å¹£åˆ¥</label><div className="flex gap-2">{Object.entries(CURRENCY_CONFIG).map(([code, conf]) => (<button key={code} onClick={() => setNewAccountCurrency(code)} className={`flex-1 py-3 rounded-xl border-2 font-bold transition-all flex items-center justify-center gap-2 ${newAccountCurrency === code ? 'border-[#1E3932] bg-[#1E3932] text-white' : 'border-[#E5E5E5] text-[#888] bg-white'}`}><span className="text-xl">{conf.flag}</span><span className="text-xs">{conf.label}</span></button>))}</div></div>
            <div><label className="block text-xs font-bold text-[#5B665E] mb-2 pl-1">å¸³æˆ¶é¡å‹</label><div className="grid grid-cols-5 gap-2">{Object.entries(ACCOUNT_TYPE_CONFIG).map(([key, config]) => (<button key={key} onClick={() => setNewAccountType(key)} className={`p-2 rounded-xl flex flex-col items-center justify-center gap-1 h-20 transition-all border-2 ${newAccountType === key ? 'bg-[#1E3932] text-white border-[#1E3932] shadow-md transform -translate-y-1' : 'bg-white text-[#888] border-[#E5E5E5]'}`}><config.icon size={20} /><span className="text-[10px] font-bold whitespace-nowrap">{config.label}</span></button>))}</div></div>
          </div>
          <button onClick={handleAddAccount} disabled={!newAccountName} className="w-full mt-8 py-4 bg-[#1E3932] text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all disabled:opacity-50">ç¢ºèªæ–°å¢</button>
        </div>
      </div>
    );
  };

  const PortalView = () => (
    <>
      <Header title="æ—¥æ—¥å¸³" showGreeting={true} />
      <div className="flex-1 overflow-y-auto px-6 pb-28 pt-2 no-scrollbar">
        {/* Net Worth Summary */}
        <div className="bg-[#1E3932] rounded-2xl p-6 shadow-lg mb-8 text-[#F2F0EB] relative overflow-hidden flex flex-col justify-between cursor-pointer active:scale-95 transition-transform" onClick={() => setActiveTab('assets')}>
           <div className="absolute right-0 top-0 bottom-0 w-32 bg-[#00704A] opacity-20 transform skew-x-12 translate-x-10"></div>
           <div className="mb-4 relative z-10">
             <div className="flex justify-between items-center mb-1"><p className="text-xs opacity-80 font-bold tracking-widest flex items-center gap-1">ğŸ‡¹ğŸ‡¼ å°å¹£ç¸½è³‡ç”¢</p><ChevronRight className="opacity-60" size={16}/></div>
             <h2 className="text-3xl font-serif font-bold tracking-wide">{formatCurrency(accountBalances.totalsByCurrency['TWD'].net, 'TWD')}</h2>
           </div>
           <div className="grid grid-cols-2 gap-4 border-t border-white/10 pt-4 relative z-10">
              <div><p className="text-[10px] opacity-60 mb-1 font-bold tracking-wider">ğŸ‡ºğŸ‡¸ ç¾å…ƒè³‡ç”¢</p><p className="text-lg font-serif font-bold">{formatCurrency(accountBalances.totalsByCurrency['USD'].net, 'USD')}</p></div>
              <div><p className="text-[10px] opacity-60 mb-1 font-bold tracking-wider">ğŸ‡¯ğŸ‡µ æ—¥åœ“è³‡ç”¢</p><p className="text-lg font-serif font-bold">{formatCurrency(accountBalances.totalsByCurrency['JPY'].net, 'JPY')}</p></div>
           </div>
        </div>

        <h3 className="text-[#5B665E] font-bold text-lg mb-4 tracking-wider">åŠŸèƒ½ç¸½è¦½</h3>
        <div className="grid grid-cols-2 gap-4">
          <button onClick={() => setActiveTab('add')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-start gap-4 hover:border-[#1E3932] active:scale-95 transition-all group">
            <div className="w-12 h-12 rounded-2xl bg-[#C6A87C] text-white flex items-center justify-center shadow-md group-hover:bg-[#1E3932] transition-colors"><Plus size={28} strokeWidth={3} /></div>
            <div className="text-left"><h4 className="text-xl font-bold text-[#1E3932]">è¨˜ä¸€ç­†</h4><p className="text-xs text-[#888] font-medium mt-1">ç´€éŒ„æ”¶æ”¯</p></div>
          </button>
          <button onClick={() => setActiveTab('home')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-start gap-4 hover:border-[#1E3932] active:scale-95 transition-all group">
            <div className="w-12 h-12 rounded-2xl bg-[#4A6C6F] text-white flex items-center justify-center shadow-md group-hover:bg-[#1E3932] transition-colors"><BookOpen size={28} strokeWidth={2.5} /></div>
            <div className="text-left"><h4 className="text-xl font-bold text-[#1E3932]">çœ‹å¸³æœ¬</h4><p className="text-xs text-[#888] font-medium mt-1">æ¯æ—¥æ˜ç´°</p></div>
          </button>
          <button onClick={() => setActiveTab('analysis')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-start gap-4 hover:border-[#1E3932] active:scale-95 transition-all group">
            <div className="w-12 h-12 rounded-2xl bg-[#00704A] text-white flex items-center justify-center shadow-md group-hover:bg-[#1E3932] transition-colors"><PieChart size={28} strokeWidth={2.5} /></div>
            <div className="text-left"><h4 className="text-xl font-bold text-[#1E3932]">çœ‹å ±è¡¨</h4><p className="text-xs text-[#888] font-medium mt-1">çµ±è¨ˆåˆ†æ</p></div>
          </button>
          <button onClick={() => setActiveTab('assets')} className="bg-white p-6 rounded-3xl shadow-sm border border-[#D4D9D5] flex flex-col items-start gap-4 hover:border-[#1E3932] active:scale-95 transition-all group">
            <div className="w-12 h-12 rounded-2xl bg-[#8C4A32] text-white flex items-center justify-center shadow-md group-hover:bg-[#1E3932] transition-colors"><Wallet size={28} strokeWidth={2.5} /></div>
            <div className="text-left"><h4 className="text-xl font-bold text-[#1E3932]">ç®¡éŒ¢åŒ…</h4><p className="text-xs text-[#888] font-medium mt-1">å¸³æˆ¶ç®¡ç†</p></div>
          </button>
        </div>

        <div className="mt-8">
           <div className="flex justify-between items-center mb-4"><h3 className="text-[#5B665E] font-bold text-lg tracking-wider">æœ€è¿‘ç´€éŒ„</h3></div>
           <div className="space-y-3">
             {transactions.slice(0, 3).map(item => {
                const cat = categories.find(c => c.id === item.category) || DEFAULT_CATEGORIES.find(c => c.id === item.category);
                const acc = accounts.find(a => a.id === item.accountId);
                const currency = acc ? (acc.currency || 'TWD') : 'TWD';
                const emoji = item.type === 'transfer' ? 'ğŸ”„' : (cat ? cat.emoji : 'âœ¨');
                const label = item.type === 'transfer' ? 'è½‰å¸³' : (cat ? cat.label : 'å…¶ä»–');
                return (
                  <div key={item.id} className="bg-white p-4 rounded-xl shadow-sm border border-[#E0E0E0] flex items-center justify-between">
                     <div className="flex items-center gap-3">
                       <div className="w-10 h-10 rounded-full bg-[#F5F5F5] flex items-center justify-center text-lg">{emoji}</div>
                       <div><p className="font-bold text-[#1E3932]">{item.note || label}</p><p className="text-xs text-[#888]">{formatDate(item.date)}</p></div>
                     </div>
                     <span className={`font-serif font-bold ${item.type === 'income' ? theme.income : item.type === 'transfer' ? theme.transfer : theme.expense}`}>
                       {item.type === 'income' ? '+' : item.type === 'transfer' ? '' : '-'}{formatCurrency(item.amount, currency)}
                     </span>
                  </div>
                )
             })}
           </div>
        </div>
      </div>
    </>
  );

  const AnalysisView = () => (
    <>
      <Header title="è²¡å‹™åˆ†æ" showBackToPortal={true} />
      <div className="px-6 flex items-center justify-center mb-6">
        <div className="bg-white p-1 rounded-full border border-[#D4D9D5] flex shadow-sm">
          <button onClick={() => setAnalysisPeriod('week')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${analysisPeriod === 'week' ? 'bg-[#1E3932] text-white shadow-md' : 'text-[#888]'}`}>æœ¬é€±</button>
          <button onClick={() => setAnalysisPeriod('month')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${analysisPeriod === 'month' ? 'bg-[#1E3932] text-white shadow-md' : 'text-[#888]'}`}>æœ¬æœˆ</button>
        </div>
      </div>
      <div className="flex-1 overflow-y-auto px-6 pb-28 no-scrollbar">
         <div className="mb-4 text-center"><span className="text-[10px] text-[#888] bg-[#F5F5F5] px-2 py-1 rounded-full">âš ï¸ ç›®å‰åƒ…åˆä½µè¨ˆç®—æ‰€æœ‰æ•¸å­—ï¼Œè«‹ç•™æ„å¹£åˆ¥å·®ç•°</span></div>

         <div className="flex gap-4 mb-8">
           <div className="flex-1 bg-white p-5 rounded-2xl shadow-sm border border-[#E0E0E0]"><p className="text-xs text-[#888] font-bold mb-1">ç¸½æ”¯å‡º</p><p className={`text-2xl font-serif font-extrabold ${theme.expense}`}>{formatCurrencySimple(analysisData.totalExp)}</p></div>
           <div className="flex-1 bg-white p-5 rounded-2xl shadow-sm border border-[#E0E0E0]"><p className="text-xs text-[#888] font-bold mb-1">ç¸½æ”¶å…¥</p><p className={`text-2xl font-serif font-extrabold ${theme.income}`}>{formatCurrencySimple(analysisData.totalInc)}</p></div>
         </div>
         <div className="mb-8">
            <h3 className="text-[#5B665E] font-bold text-lg mb-4">æ¶ˆè²»é¡åˆ¥çµ±è¨ˆ</h3>
            <div className="bg-white rounded-2xl p-4 shadow-sm border border-[#E0E0E0] space-y-4">
              {analysisData.sortedCategory.length > 0 ? (
                analysisData.sortedCategory.map((item, idx) => ( 
                  <div key={idx} className="flex items-center justify-between border-b border-[#F5F5F5] last:border-0 pb-3 last:pb-0">
                    <div className="flex items-center gap-3">
                      <span className="text-sm font-bold text-[#1E3932]">{item.key}</span>
                      <span className="text-[10px] text-[#888] font-bold">{item.percent.toFixed(0)}%</span>
                    </div>
                    <span className="text-lg font-serif font-bold text-[#1E3932]">{formatCurrencySimple(item.val)}</span>
                  </div>
                ))
              ) : (
                <div className="text-center py-8 opacity-50"><p>å°šç„¡æ”¯å‡ºç´€éŒ„</p></div>
              )}
            </div>
         </div>
      </div>
    </>
  );

  const TransactionsView = () => (
    <>
      <Header title="å¸³æœ¬æ˜ç´°" subtitle={`${new Date().getMonth() + 1}æœˆ`} />
       <div className="px-6 mb-6 mt-6">
        <div className={`bg-[#1E3932] rounded-[2rem] p-8 shadow-lg relative overflow-hidden text-[#F2F0EB]`}>
          <div className="absolute -top-12 -right-12 w-48 h-48 bg-[#00704A] rounded-full opacity-20"></div>
          <p className="text-base opacity-80 mb-2 font-medium tracking-wider">ğŸ‡¹ğŸ‡¼ æœ¬æœˆå°å¹£æ·¨æµå‘</p>
          <h2 className="text-4xl font-serif font-bold mb-8 tracking-wide">{formatCurrency(currentMonthStats.balance, 'TWD')}</h2>
          <div className="flex gap-4">
            <div className="flex-1 bg-white/10 backdrop-blur-sm p-4 rounded-2xl border border-white/10"><span className="text-sm">ğŸ’° æ”¶å…¥</span><p className="text-xl font-bold">{formatCurrency(currentMonthStats.income, 'TWD')}</p></div>
            <div className="flex-1 bg-white/10 backdrop-blur-sm p-4 rounded-2xl border border-white/10"><span className="text-sm">ğŸ’¸ æ”¯å‡º</span><p className="text-xl font-bold">{formatCurrency(currentMonthStats.expense, 'TWD')}</p></div>
          </div>
          <p className="text-[10px] mt-4 opacity-50 text-center">* åƒ…çµ±è¨ˆå°å¹£å¸³æˆ¶äº¤æ˜“</p>
        </div>
      </div>
      <div className="flex-1 overflow-y-auto px-6 pb-28 no-scrollbar">
          {groupedTransactions.map(([dateKey, items]) => (
            <div key={dateKey} className="mb-8">
              <div className="flex items-baseline gap-3 mb-4 sticky top-0 bg-[#F2F0EB]/95 backdrop-blur-sm py-3 z-0"><span className={`text-xl font-extrabold font-serif ${theme.textMain}`}>{formatDate(dateKey)}</span></div>
              <div className="space-y-4">
                {items.map((item) => {
                  const cat = categories.find(c => c.id === item.category) || DEFAULT_CATEGORIES.find(c => c.id === item.category);
                  const acc = accounts.find(a => a.id === item.accountId);
                  const accConfig = acc ? ACCOUNT_TYPE_CONFIG[acc.type] : ACCOUNT_TYPE_CONFIG.cash;
                  const currency = acc ? (acc.currency || 'TWD') : 'TWD';
                  const isTransfer = item.type === 'transfer';
                  const toAcc = isTransfer ? accounts.find(a => a.id === item.toAccountId) : null;
                  const emoji = isTransfer ? 'ğŸ”„' : (cat ? cat.emoji : 'âœ¨');
                  const label = isTransfer ? 'è½‰å¸³' : (cat ? cat.label : 'å…¶ä»–');
                  return (
                    <div key={item.id} className="group bg-white p-5 rounded-2xl shadow-sm border border-[#E0E0E0] hover:border-[#1E3932] transition-all flex items-center justify-between">
                      <div className="flex items-center gap-4"><div className="w-12 h-12 rounded-full flex items-center justify-center text-2xl bg-[#F5F5F5]">{emoji}</div><div className="flex flex-col"><span className={`text-lg font-bold ${theme.textMain}`}>{item.note || label}</span><div className="flex items-center gap-2 flex-wrap">{isTransfer ? (<span className="text-xs font-bold text-[#888] flex items-center gap-1">{acc?.name} <ArrowRight size={10} /> {toAcc?.name}</span>) : (<><span className="text-xs font-bold text-white px-2 py-0.5 rounded-full flex items-center gap-1" style={{ backgroundColor: accConfig.color }}><accConfig.icon size={10} /> {acc ? acc.name : 'æœªçŸ¥'}</span><span className="text-xs font-medium text-[#888]">{label}</span></>)}</div></div></div>
                      <div className="flex flex-col items-end gap-1"><span className={`text-lg font-extrabold font-serif ${item.type === 'income' ? theme.income : item.type === 'transfer' ? theme.transfer : theme.expense}`}>{item.type === 'income' ? '+' : item.type === 'transfer' ? '' : '-'}{formatCurrency(item.amount, currency)}</span><button onClick={() => handleDeleteTransaction(item.id)} className="text-xs font-bold text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">åˆªé™¤</button></div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
      </div>
    </>
  );

  const AssetsView = () => {
    if (selectedAssetCategory) {
      const config = ACCOUNT_TYPE_CONFIG[selectedAssetCategory];
      const categoryAccounts = accounts.filter(a => a.type === selectedAssetCategory);
      return (
        <>
          <Header title={config.label} showBackToPortal={false} onBack={() => setSelectedAssetCategory(null)} subtitle="è©³ç´°åˆ—è¡¨" />
          <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 no-scrollbar">
             <button onClick={() => { setNewAccountType(selectedAssetCategory); setIsAddingAccountModalOpen(true); }} className="w-full py-4 mb-6 rounded-2xl border-2 border-dashed border-[#8FA79A] bg-[#F9F9F7] text-[#1E3932] font-bold flex items-center justify-center gap-2 hover:bg-[#EAEAEA] active:scale-95 transition-all"><Plus size={20} strokeWidth={3} /><span>æ–°å¢{config.label}</span></button>
             <div className="grid gap-4">{categoryAccounts.length > 0 ? categoryAccounts.map(acc => { const balance = accountBalances.balances[acc.id] || 0; const currency = acc.currency || 'TWD'; return (<div key={acc.id} className="bg-white rounded-2xl p-5 shadow-sm border border-[#E0E0E0] flex items-center justify-between relative overflow-hidden group"><div className="absolute left-0 top-0 bottom-0 w-2" style={{ backgroundColor: config.color }}></div><div className="flex items-center gap-4 pl-2"><div className="w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-sm" style={{ backgroundColor: config.color }}><config.icon size={24} /></div><div><h4 className={`font-bold text-lg ${theme.textMain}`}>{acc.name}</h4><p className="text-xs text-[#888] font-medium">{formatCurrency(balance, currency)}</p></div></div><button onClick={(e) => { e.stopPropagation(); handleDeleteAccount(acc.id); }} className="text-red-300 hover:text-red-500 p-2"><Trash2 size={20} /></button></div>) }) : (<div className="text-center py-10 opacity-50"><p>å°šç„¡å¸³æˆ¶</p></div>)}</div>
             <div className="mt-8 flex justify-center"><button onClick={() => setSelectedAssetCategory(null)} className="flex items-center gap-2 text-[#888] hover:text-[#1E3932] transition-colors"><ChevronLeft size={16}/> è¿”å›ç¸½è¦½</button></div>
          </div>
        </>
      );
    }
    return (
      <>
        <Header title="è³‡ç”¢å¸³æˆ¶" />
        <div className="flex-1 overflow-y-auto px-6 pb-28 pt-4 no-scrollbar">
          <div className="bg-[#1E3932] rounded-[2rem] p-8 shadow-lg mb-8 text-[#F2F0EB] relative">
            <div className="absolute top-0 right-0 p-6 opacity-20"><Landmark size={80} /></div>
            <div className="space-y-6">
              <div><p className="text-sm opacity-80 mb-2 font-bold tracking-widest flex items-center gap-2"><span className="text-lg">ğŸ‡¹ğŸ‡¼</span> å°å¹£ç¸½è³‡ç”¢</p><h2 className="text-4xl font-serif font-bold tracking-wide mb-2">{formatCurrency(accountBalances.totalsByCurrency['TWD'].net, 'TWD')}</h2></div>
              <div className="flex gap-8 border-t border-white/20 pt-4"><div><p className="text-xs opacity-60 mb-1 font-bold">ğŸ‡ºğŸ‡¸ ç¾å…ƒ</p><span className="font-serif font-bold text-xl">{formatCurrency(accountBalances.totalsByCurrency['USD'].net, 'USD')}</span></div><div><p className="text-xs opacity-60 mb-1 font-bold">ğŸ‡¯ğŸ‡µ æ—¥åœ“</p><span className="font-serif font-bold text-xl">{formatCurrency(accountBalances.totalsByCurrency['JPY'].net, 'JPY')}</span></div></div>
            </div>
          </div>
          <h3 className="text-[#5B665E] font-bold text-lg mb-4 tracking-wider flex items-center gap-2"><Wallet size={20} /> æˆ‘çš„éŒ¢åŒ…åˆ†é¡</h3>
          <div className="grid gap-4">{Object.entries(ACCOUNT_TYPE_CONFIG).map(([key, config]) => { const count = accounts.filter(a => a.type === key).length; return (<button key={key} onClick={() => setSelectedAssetCategory(key)} className="bg-white rounded-2xl p-5 shadow-sm border border-[#E0E0E0] flex items-center justify-between hover:border-[#1E3932] transition-all group active:scale-95"><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-sm" style={{ backgroundColor: config.color }}><config.icon size={24} /></div><div className="text-left"><h4 className={`font-bold text-lg ${theme.textMain}`}>{config.label}</h4><p className="text-xs text-[#888] font-medium">{count} å€‹å¸³æˆ¶</p></div></div><ChevronRight size={20} className="text-[#CCC] group-hover:text-[#1E3932]" /></button>) })}</div>
        </div>
      </>
    );
  };

  const AddTransactionModal = () => {
    if (activeTab !== 'add') return null;
    const selectedAcc = accounts.find(a => a.id === selectedAccountId);
    const currencyCode = selectedAcc ? (selectedAcc.currency || 'TWD') : 'TWD';
    const currencyConfig = CURRENCY_CONFIG[currencyCode];
    
    const toggleCalc = () => {
       if (!showCalculator) {
          amountInputRef.current?.blur();
       }
       setShowCalculator(!showCalculator);
    };

    return (
      <div className="fixed inset-0 z-50 bg-[#F2F0EB] flex flex-col animate-fade-in md:absolute md:inset-0 md:rounded-[3rem] md:overflow-hidden">
        <div className="pt-14 px-6 pb-4 flex justify-between items-center bg-white shadow-sm z-20">
          <button onClick={() => setActiveTab('portal')} className="p-3 -ml-2 text-[#1E3932] hover:bg-gray-100 rounded-full transition-colors"><X size={32} strokeWidth={2.5} /></button>
          <div className="flex gap-1 bg-[#F5F5F5] p-1 rounded-full overflow-hidden">{[ {id: 'expense', label: 'æ”¯å‡º'}, {id: 'income', label: 'æ”¶å…¥'}, {id: 'transfer', label: 'è½‰å¸³'}].map(t => (<button key={t.id} onClick={() => setType(t.id)} className={`px-5 py-2 rounded-full text-sm font-bold transition-all ${type === t.id ? 'bg-white shadow-sm text-[#1E3932]' : 'text-[#888]'}`}>{t.label}</button>))}</div>
          <div className="w-10"></div>
        </div>
        <div className="flex-1 overflow-y-auto px-6 py-8">
          <div className="mb-4 text-center">
            <label className="block text-sm font-bold text-[#5B665E] mb-3 tracking-widest">è¼¸å…¥é‡‘é¡ ({currencyConfig.label})</label>
            <div className="relative inline-block w-full">
               <span className={`absolute left-0 top-1/2 -translate-y-1/2 text-xl font-bold ${type === 'expense' ? theme.expense : type === 'income' ? theme.income : theme.transfer} flex items-center gap-1`}><span className="text-2xl">{type === 'expense' ? '-' : type === 'income' ? '+' : 'â‡„'}</span><span>{currencyConfig.symbol}</span></span>
               <input 
                 ref={amountInputRef}
                 type="number" 
                 value={amount} 
                 onChange={(e) => setAmount(e.target.value)} 
                 placeholder="0" 
                 className={`w-full text-center text-6xl font-serif font-extrabold bg-transparent outline-none placeholder-[#D0D0D0] ${theme.textMain} py-2 pl-8`} 
               />
            </div>
            
            <div className="flex justify-center mt-2">
               <button 
                 onClick={toggleCalc} 
                 className={`flex items-center gap-2 px-6 py-2 rounded-full transition-all shadow-sm ${showCalculator ? 'bg-[#1E3932] text-white shadow-inner' : 'bg-white text-[#1E3932] border border-[#D4D9D5] hover:bg-gray-50'}`}
               >
                 <Calculator size={18} />
                 <span className="text-sm font-bold">å°è¨ˆç®—æ©Ÿ</span>
               </button>
            </div>
          </div>

          {showCalculator && (
             <div className="mb-8 animate-in slide-in-from-top-4">
                <CalculatorPad 
                   onValueChange={(val) => setAmount(val)} 
                   onConfirm={() => setShowCalculator(false)}
                />
             </div>
          )}

          {type === 'transfer' ? (
             <div className="mb-10 space-y-6">
                <AccountSelector accounts={accounts} selectedId={selectedAccountId} onSelect={setSelectedAccountId} label="å¾ (è½‰å‡º)" />
                <div className="flex justify-center -my-3 relative z-10"><div className="bg-[#F2F0EB] p-2 rounded-full border border-[#D4D9D5]"><ArrowRight size={24} className="text-[#1E3932]" /></div></div>
                <AccountSelector accounts={accounts} selectedId={toAccountId} onSelect={setToAccountId} label="åˆ° (è½‰å…¥)" />
             </div>
          ) : (
             <>
               <AccountSelector accounts={accounts} selectedId={selectedAccountId} onSelect={setSelectedAccountId} label="æ”¯ä»˜å¸³æˆ¶" />
               <div className="mb-8"><div className="flex justify-between items-center mb-4 px-2"><label className="text-sm font-bold text-[#5B665E] tracking-widest">- é¸æ“‡åˆ†é¡ -</label><button onClick={() => setIsManagingCategories(!isManagingCategories)} className="text-xs font-bold text-[#C6A87C] flex items-center gap-1"><Settings size={12} /> ç®¡ç†</button></div>
                  {isManagingCategories ? (
                     <div className="bg-white p-4 rounded-2xl border-2 border-[#D4D9D5] mb-4 animate-in slide-in-from-top-2"><h4 className="font-bold text-[#1E3932] mb-3 text-center text-sm">æ–°å¢åˆ†é¡</h4><div className="flex gap-2 mb-3"><input type="text" value={newCategoryEmoji} onChange={e => setNewCategoryEmoji(e.target.value)} className="w-12 text-center bg-[#F5F5F5] rounded-lg p-2 text-xl" placeholder="Emoji" /><SafeInput value={newCategoryName} onChange={setNewCategoryName} className="flex-1 bg-[#F5F5F5] rounded-lg p-2 text-sm font-bold text-gray-800 border-2 border-transparent focus:border-[#1E3932] focus:bg-white transition-colors" placeholder="åˆ†é¡åç¨±" /><button onClick={handleAddCategory} className="bg-[#1E3932] text-white px-4 rounded-lg font-bold text-xs">æ–°å¢</button></div><div className="grid grid-cols-4 gap-2 mt-4 max-h-40 overflow-y-auto">{categories.map(cat => (<div key={cat.id} className="relative group border rounded-lg p-2 flex flex-col items-center"><span className="text-xl">{cat.emoji}</span><span className="text-[10px] mt-1 truncate w-full text-center">{cat.label}</span><button onClick={() => handleDeleteCategory(cat.id)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center"><X size={10} /></button></div>))}</div></div>
                  ) : (
                     <div className="grid grid-cols-3 gap-3 px-1">
                        {categories.map((cat) => (
                          <button 
                            key={cat.id} 
                            onClick={() => setSelectedCategoryId(cat.id)} 
                            className={`relative flex flex-col items-center gap-1 p-4 rounded-2xl transition-all duration-100 border-2 border-b-[5px] active:border-b-2 active:translate-y-[3px] ${selectedCategoryId === cat.id ? 'bg-[#F2F0EB] border-[#1E3932] border-b-[#1E3932] text-[#1E3932]' : 'bg-white border-gray-200 border-b-gray-300 text-[#888] hover:bg-gray-50'}`}
                          >
                            <div className="text-4xl mb-1">{cat.emoji}</div>
                            <span className="text-sm font-bold tracking-wide">{cat.label}</span>
                            {selectedCategoryId === cat.id && <div className="absolute top-2 right-2 w-2 h-2 bg-[#C6A87C] rounded-full"></div>}
                          </button>
                        ))}
                        <button onClick={() => setIsManagingCategories(true)} className="flex flex-col items-center justify-center gap-1 p-4 rounded-2xl border-2 border-dashed border-gray-300 text-gray-400 hover:bg-white hover:border-[#1E3932] hover:text-[#1E3932] transition-colors">
                           <Plus size={32} />
                        </button>
                     </div>
                  )}
               </div>
             </>
          )}
          <div className="space-y-4 mb-24"><div className="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm border border-[#D4D9D5]"><Calendar size={24} className="text-[#1E3932]" /><input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={`flex-1 bg-transparent text-lg font-bold ${theme.textMain} outline-none`} /></div><div className="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm border border-[#D4D9D5]"><span className="text-[#1E3932] text-lg font-serif font-bold pl-1">è¨»</span><SafeInput value={note} onChange={setNote} placeholder={type === 'transfer' ? "ä¾‹å¦‚ï¼šè²·ç¾è‚¡" : "å¯«é»ä»€éº¼..."} className={`flex-1 bg-transparent text-lg font-bold text-gray-800 outline-none placeholder-[#A0A0A0]`} /></div></div>
        </div>
        <div className="fixed bottom-0 w-full max-w-md bg-white p-6 shadow-[0_-5px_25px_rgba(0,0,0,0.05)] border-t border-[#F5F5F5] md:absolute md:w-full">
          <button onClick={handleAddTransaction} disabled={!amount || isSubmitting} className={`w-full py-5 rounded-full text-white text-xl font-extrabold tracking-widest shadow-xl transform transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 ${type === 'expense' ? 'bg-[#8C4A32] shadow-[#8C4A32]/30' : type === 'income' ? 'bg-[#00704A] shadow-[#00704A]/30' : 'bg-[#1E3932] shadow-[#1E3932]/30'}`}>{isSubmitting ? 'ç´€éŒ„ä¸­...' : type === 'transfer' ? 'ç¢ºèªè½‰å¸³' : 'ç¢ºèªè¨˜å¸³'}</button>
        </div>
      </div>
    );
  };

  const TabBar = () => (
    <div className="fixed bottom-0 w-full bg-white/95 backdrop-blur-xl pt-3 pb-8 px-8 shadow-[0_-5px_30px_rgba(0,0,0,0.05)] flex justify-between items-center z-10 border-t border-[#E5E5E5] md:absolute md:w-full">
      <button onClick={() => setActiveTab('portal')} className={`p-2 rounded-xl flex flex-col items-center gap-1.5 transition-all w-16 ${activeTab === 'portal' ? theme.primaryText : 'text-[#A0A0A0]'}`}><LayoutGrid size={26} strokeWidth={activeTab === 'portal' ? 3 : 2} /><span className="text-[10px] font-bold">ä¸»é¸å–®</span></button>
      <button onClick={() => setActiveTab('home')} className={`p-2 rounded-xl flex flex-col items-center gap-1.5 transition-all w-16 ${activeTab === 'home' ? theme.primaryText : 'text-[#A0A0A0]'}`}><ListOrdered size={26} strokeWidth={activeTab === 'home' ? 3 : 2} /><span className="text-[10px] font-bold">å¸³æœ¬</span></button>
      <button onClick={() => setActiveTab('add')} className="bg-[#1E3932] text-white w-16 h-16 rounded-full flex items-center justify-center shadow-2xl shadow-[#1E3932]/40 transform -translate-y-6 hover:scale-105 transition-all active:scale-95 border-4 border-[#F2F0EB] mx-2"><Plus size={36} strokeWidth={3} /></button>
      <button onClick={() => setActiveTab('assets')} className={`p-2 rounded-xl flex flex-col items-center gap-1.5 transition-all w-16 ${activeTab === 'assets' ? theme.primaryText : 'text-[#A0A0A0]'}`}><Wallet size={26} strokeWidth={activeTab === 'assets' ? 3 : 2} /><span className="text-[10px] font-bold">è³‡ç”¢</span></button>
      <button onClick={() => setActiveTab('settings')} className={`p-2 rounded-xl flex flex-col items-center gap-1.5 transition-all w-16 ${activeTab === 'settings' ? theme.primaryText : 'text-[#A0A0A0]'}`}><UserCog size={26} strokeWidth={activeTab === 'settings' ? 3 : 2} /><span className="text-[10px] font-bold">è¨­å®š</span></button>
    </div>
  );

  if (isLoading) return <LoadingScreen />;

  return (
    <div className={`min-h-screen w-full bg-[#F2F0EB] text-[#1E3932] font-sans relative overflow-hidden flex flex-col md:max-w-2xl md:mx-auto md:border-x md:border-[#D4D9D5] md:shadow-2xl md:my-8 md:rounded-[2.5rem]`}>
      {activeTab === 'portal' && <PortalView />}
      {activeTab === 'home' && <TransactionsView />}
      {activeTab === 'assets' && <AssetsView />}
      {activeTab === 'analysis' && <AnalysisView />}
      {activeTab === 'settings' && <SettingsView />}
      {activeTab !== 'add' && <TabBar />}
      <AddTransactionModal />
      <AddAccountModal />
      <SystemDialog 
         isOpen={dialogConfig.isOpen} 
         type={dialogConfig.type} 
         title={dialogConfig.title} 
         message={dialogConfig.message} 
         onConfirm={dialogConfig.onConfirm} 
         onCancel={dialogConfig.onCancel || (() => setDialogConfig(prev => ({...prev, isOpen: false})))}
         isDanger={dialogConfig.isDanger}
      />
      <UserManualModal />
    </div>
  );
}

